<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Caja Mercado Limpio</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
  :root {
    --primary:#0077b6;
    --success:#2e7d32;
    --danger:#c62828;
    --warning:#ff9800;
  }
  body {
    font-family:'Roboto',sans-serif;
    background:#f0f2f5;
    margin:0;
    overflow:hidden;
  }
  .header {
    height:60px;background:var(--primary);display:flex;
    align-items:center;justify-content:space-between;
    padding:0 20px;color:white;font-weight:700;
  }
  .nav-btns {display:flex;overflow-x:auto;background:white;border-bottom:1px solid #ddd;}
  .nav-btn {flex:1;padding:12px 0;text-align:center;cursor:pointer;font-size:0.92rem;font-weight:700;border-bottom:3px solid transparent;}
  .nav-btn.active {color:var(--primary);border-color:var(--primary);}
  .view-section{display:none;padding:15px;height:calc(100vh - 120px);overflow-y:auto;animation:fadeIn .3s;}
  .view-section.active{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
  .card{background:white;border-radius:12px;padding:20px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,0.07);}
  .form-control{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd;font-size:.95rem;}
  .btn-main{width:100%;padding:14px;background:var(--primary);color:white;font-weight:900;border-radius:10px;font-size:1rem;border:none;margin-top:10px;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px;}
  .btn-main:disabled{opacity:0.5;pointer-events:none}
  #toast-container{position:fixed;top:15px;right:15px;z-index:3000;width:280px;}
  .toast{padding:12px;margin-bottom:8px;border-radius:8px;color:white;font-weight:700;opacity:0;transform:translateX(100px);transition:.3s;}
  .toast.show{opacity:1;transform:translateX(0);}
  #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.85);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:5000;display:none;font-weight:900;font-size:1.3rem;color:var(--primary);}
  .diff-bar{text-align:center;padding:10px;font-weight:700;border-radius:8px;margin-top:12px;font-size:1rem;border:1px solid #ccc;background:#fafafa;}
  .mov-item{display:flex;justify-content:space-between;background:white;padding:10px;border-radius:10px;margin-bottom:10px;border-left:6px solid var(--primary);}
  .amount-in{color:var(--success);font-weight:900;}
  .amount-out{color:var(--danger);font-weight:900;}
  .inp-billete{width:80px;text-align:center;font-size:1rem;border:none;border-bottom:2px solid #eee;}
</style>
</head>

<body>
<div class="header">
  <span>Caja Mercado Limpio</span>
  <span id="header-time">--:--</span>
</div>

<div class="nav-btns">
  <div class="nav-btn active" data-target="view-movimientos">Movimientos</div>
  <div class="nav-btn" data-target="view-rendicion">Rendici√≥n</div>
  <div class="nav-btn" data-target="view-arqueo">Arqueo</div>
</div>

<div id="toast-container"></div>
<div id="loading-overlay">Procesando...</div>

<!-- MOVIMIENTOS -->
<section class="view-section active" id="view-movimientos">
  <div class="card">
    <h2 style="font-weight:900;">Registrar Movimiento</h2>
    <select id="mov-tipo" class="form-control">
      <option value="Ingreso">üü¢ Ingreso</option>
      <option value="Egreso">üîª Egreso</option>
    </select>
    <select id="mov-pago" class="form-control">
      <option value="Efectivo">üíµ Efectivo</option>
      <option value="Banco">üè¶ Banco</option>
      <option value="Cheque">üßæ Cheque</option>
    </select>
    <select id="mov-categoria" class="form-control"></select>
    <input id="mov-empleado" class="form-control" placeholder="Empleado (si aplica)">
    <input id="mov-proveedor" class="form-control" placeholder="Proveedor (si aplica)">
    <input id="mov-importe" class="form-control" placeholder="Importe $">
    <input id="mov-obs" class="form-control" placeholder="Observaci√≥n (opcional)">
    <button class="btn-main" onclick="registrarMovimiento()">
      <span class="material-icons-round">send</span> Guardar
    </button>
  </div>

  <div class="card">
    <h2 style="font-weight:900;">Movimientos del D√≠a</h2>
    <input type="date" id="fecha-historial" class="form-control" onchange="cargarMovimientos()">
    <div id="lista-movimientos"></div>
  </div>
</section>

<!-- RENDICION -->
<section class="view-section" id="view-rendicion">
  <div class="card">
    <h2 style="font-weight:900;text-align:center;">Rendici√≥n üßÆ</h2>
    <div id="rendicion-status-text" style="text-align:center;">Buscando...</div>
    <div id="rendicion-detalle-humano"
         style="text-align:center;font-size:0.9rem;margin-bottom:6px;">--</div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div style="text-align:center;">
        <small>Esperado</small>
        <div id="rendicion-esperado" style="font-size:1.6rem;font-weight:900;">$0</div>
      </div>
      <div style="text-align:center;">
        <small>Contado</small>
        <div id="rendicion-contado"
             data-numeric="0"
             style="font-size:1.6rem;font-weight:900;">$0</div>
      </div>
    </div>

    <div id="live-diff-display" class="diff-bar">
      Ingres√° billetes
    </div>

    <div id="bill-counter-container"></div>

    <button class="btn-main" id="btn-procesar-rendicion">
      <span class="material-icons-round">check_circle</span>
      Confirmar Rendici√≥n
    </button>

    <div id="ultimo-cierre-box" class="card"
      style="display:none;background:#eef6ff;border:2px dashed var(--primary);margin-top:12px;">
      <h3 style="text-align:center;font-weight:900;color:var(--primary);">
        ¬°Excelente trabajo Laura! üéâ
      </h3>
      <div id="ultimo-cierre-detalle" style="text-align:center;">
      </div>
    </div>
  </div>
</section>

<!-- ARQUEO -->
<section class="view-section" id="view-arqueo">
  <div class="card">
    <h2 style="font-weight:900;text-align:center;">Arqueo Final</h2>
    <p style="text-align:center;font-weight:700;color:#444;">
      Sistema: <span id="arqueo-valor-sistema">$0</span>
    </p>
    <p style="text-align:center;font-weight:700;color:#444;">
      F√≠sico: <span id="arqueo-fisico-display">$0</span>
    </p>

    <div id="arqueo-billetes-container"></div>

    <button class="btn-main btn-orange" onclick="intentarArqueo()">
      <span class="material-icons-round">lock_person</span>
      Cerrar Caja
    </button>
  </div>
</section>

<script>
// =======================
// CONFIG
// =======================
const API_URL = "https://cajamercadolimpio.santamariapablodaniel.workers.dev/";
const USUARIO_APP = "Laura";
let datosRend = null;
let saldoSistema = 0;

// =======================
// INIT
// =======================
document.addEventListener("DOMContentLoaded", () => {
  setFechaHoy();
  actualizarCategorias();
  cargarMovimientos();
  actualizarSaldo();
  
  crearContadorBilletes();
  crearArqueoBilletes();

  buscarRendicionPendiente();

  document.querySelectorAll(".nav-btn").forEach(btn=>{
    btn.addEventListener("click",()=>showView(btn.dataset.target,btn));
  });

  document.getElementById("btn-procesar-rendicion")
          .addEventListener("click", intentarProcesarRendicion);

  actualizarHoraHeader();
  setInterval(actualizarHoraHeader,60000);
});

// =======================
// UTILS
// =======================
function formatear(n){return "$ "+Number(n).toLocaleString("es-AR");}
function toast(msg, ok=true){
  const box=document.createElement("div");
  box.className="toast" + (ok?"":" show");
  box.style.background=ok?varSuccess():varDanger();
  box.innerText=msg;
  document.getElementById("toast-container").appendChild(box);
  setTimeout(()=>box.classList.add("show"),10);
  setTimeout(()=>box.remove(),4000);
}
const varSuccess=()=>getComputedStyle(document.documentElement).getPropertyValue("--success");
const varDanger=()=>getComputedStyle(document.documentElement).getPropertyValue("--danger");
function showLoading(msg="Procesando..."){document.getElementById("loading-overlay").innerText=msg;document.getElementById("loading-overlay").style.display="flex";}
function hideLoading(){document.getElementById("loading-overlay").style.display="none";}
function setFechaHoy(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  document.getElementById("fecha-historial").value=`${yyyy}-${mm}-${dd}`;
}
function actualizarHoraHeader(){
  const d=new Date();
  document.getElementById("header-time").innerText=
    d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0");
}

// =======================
// API
// =======================
async function api(fn, params = {}){
  try{
    const r = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify({fn,params})
    });
    return await r.json();
  }catch(e){console.error("API:",e);return null;}
}

// =======================
// UI
// =======================
function showView(sec,btn){
  document.querySelectorAll(".view-section").forEach(x=>x.classList.remove("active"));
  document.getElementById(sec).classList.add("active");

  document.querySelectorAll(".nav-btn").forEach(x=>x.classList.remove("active"));
  btn.classList.add("active");

  if(sec==="view-arqueo") actualizarSaldo();
}

// ===========================
// CATEGORIAS
// ===========================
function actualizarCategorias(){
  const tipo=document.getElementById("mov-tipo").value;
  const sel=document.getElementById("mov-categoria");
  sel.innerHTML="";
  let list=tipo==="Egreso" ?
    ["Pago a Proveedor","Combustible","Adelanto Sueldo","Pago de Haberes","Gastos Varios"]
    : ["Ingreso por Ventas","Ingreso Varios","Aporte de Capital"];
  list.forEach(c=>{
    const op=document.createElement("option");
    op.value=c;op.textContent=c;sel.appendChild(op);
  });
}

// ===========================
// MOVIMIENTOS
// ===========================
async function cargarMovimientos(){
  const fecha=document.getElementById("fecha-historial").value+"T12:00:00";
  const box=document.getElementById("lista-movimientos");
  box.innerHTML="Cargando‚Ä¶";
  const r=await api("getMovimientos",{fechaStr:fecha});
  box.innerHTML="";
  if(!r||r.length===0) return box.innerHTML="Sin movimientos";
  r.forEach(m=>{
    box.innerHTML+=`
    <div class="mov-item">
      <div><b>${m.categoria}</b><br><small>${m.hora} ¬∑ ${m.formaPago}</small></div>
      <div class="${m.tipo==="Ingreso"?"amount-in":"amount-out"}">
        ${(m.tipo==="Ingreso"?"+":"-")+formatear(m.importe)}
      </div>
    </div>`;
  });
}

// ===========================
// REGISTRAR MOVIMIENTO
// ===========================
async function registrarMovimiento(){
  const tipo=mov("tipo"),pago=mov("pago"),cat=mov("categoria"),imp=Number(mov("importe").replace(/\./g,"")),obs=mov("obs");
  let emp=mov("empleado"),prov=mov("proveedor");
  if(!cat) return toast("Falta categor√≠a",false);
  if(!imp||imp<=0) return toast("Importe inv√°lido",false);
  if(cat.includes("Haberes")) await recordarAdelantos();
  showLoading("Guardando...");
  const r=await api("registrarMovimientoCaja",{tipo,formaPago:pago,categoria:cat,importe:imp,observacion:`${emp||""} ${prov||""} ${obs||""}`,usuario:USUARIO_APP});
  hideLoading();
  if(!r||!r.ok) return toast("Error",false);
  toast("Guardado ‚úîÔ∏è");
  ["importe","obs","empleado","proveedor"].forEach(x=>document.getElementById("mov-"+x).value="");
  cargarMovimientos();actualizarSaldo();
}
const mov=id=>document.getElementById("mov-"+id).value||"";

async function recordarAdelantos(){
  const emp=document.getElementById("mov-empleado").value;
  if(!emp) return;
  const r=await api("getAdelantosSemana",{empleado:emp});
  if(r&&r.total>0) toast(`‚ö†Ô∏è ${emp} pidi√≥ ${r.cant} adelantos: ${formatear(r.total)}`,false);
}

// ===========================
// SALDO HEADER
// ===========================
async function actualizarSaldo(){
  const r=await api("getEstadoCaja");
  if(!r) return;
  saldoSistema=Number(r.efectivo);
  if(document.getElementById("arqueo-valor-sistema"))
    document.getElementById("arqueo-valor-sistema").innerText=formatear(saldoSistema);
}

// ===========================
// RENDICION
// ===========================
async function buscarRendicionPendiente(){
  const box=gid("rendicion-status-text");
  const h=gid("rendicion-detalle-humano");
  const r=await api("getRendicionPendiente");
  if(!r||!r.ok){
    box.innerText="No hay rendiciones pendientes";
    datosRend=null;
    return;
  }
  datosRend=r;
  box.innerHTML="Planilla detectada ‚úîÔ∏è";
  h.innerHTML=`<b>${r.repartidor}</b> ¬∑ ${r.turno}`;
  gid("rendicion-esperado").innerText=formatear(r.efectivoEsperado);
}

function crearContadorBilletes(){
  const c=gid("bill-counter-container");
  c.innerHTML="";
  [20000,10000,2000,1000,500,200,100,50,20,10].forEach(v=>{
    c.innerHTML+=`
    <div class="bill-box">
      <strong>$${v.toLocaleString("es-AR")}</strong>
      <input type="number" data-den="${v}" class="inp-billete" oninput="calcRendicion()">
    </div>`;
  });
}

function calcRendicion(){
  if(!datosRend) return;
  let total=0;
  document.querySelectorAll(".inp-billete").forEach(inp=>{
    total+= (Number(inp.value)||0)*Number(inp.dataset.den);
  });
  gid("rendicion-contado").dataset.numeric=total;
  gid("rendicion-contado").innerText=formatear(total);
  const dif=total-datosRend.efectivoEsperado;
  const box=gid("live-diff-display");
  if(dif===0){box.innerText="‚ú® Exacto ‚ú®";box.style.background="#e8f5e9";}
  else if(dif>0){box.innerText="Sobrante "+formatear(dif);box.style.background="#fff8e1";}
  else{box.innerText="Faltante "+formatear(Math.abs(dif));box.style.background="#ffebee";}
}

async function intentarProcesarRendicion(){
  if(!datosRend) return toast("No hay rendici√≥n",false);
  const total=Number(gid("rendicion-contado").dataset.numeric);
  if(!total) return toast("Cont√° billetes",false);
  showLoading("Guardando Rendici√≥n...");
  const r=await api("procesarRendicionDesdeRecibo",{fechaStr:datosRend.fecha,turno:datosRend.turno,repartidor:datosRend.repartidor,efectivoContado:total,usuario:USUARIO_APP});
  hideLoading();
  if(!r||!r.ok) return toast("Error en rendici√≥n",false);
  toast("Rendici√≥n guardada ‚úîÔ∏è");
  datosRend=null;
  gid("view-rendicion").innerHTML="<div style='text-align:center;padding:25px;font-size:1.2rem;'>‚ú® Rendici√≥n del d√≠a guardada ‚ú®</div>";
  actualizarSaldo();cargarMovimientos();
}

// ===========================
// ARQUEO
// ===========================
function crearArqueoBilletes(){
  const c=document.getElementById("arqueo-billetes-container");
  c.innerHTML="";
  [20000,10000,2000,1000,500,200,100,50,20,10].forEach(v=>{
    c.innerHTML+=`
    <div class="bill-box">
      <strong>$${v.toLocaleString("es-AR")}</strong>
      <input type="number" data-den="${v}" class="inp-billete" oninput="calcArqueo()">
    </div>`;
  });
}

function calcArqueo(){
  let total=0;
  document.querySelectorAll("#arqueo-billetes-container .inp-billete").forEach(inp=>{
    total+= (Number(inp.value)||0)*Number(inp.dataset.den);
  });
  gid("arqueo-fisico-display").innerText=formatear(total);
}

async function intentarArqueo(){
  const fis=Number(gid("arqueo-fisico-display").innerText.replace(/\D/g,""));
  showLoading("Cerrando caja...");
  const r=await api("registrarArqueo",{usuario:USUARIO_APP,efectivoFisico:fis});
  hideLoading();
  if(!r||!r.resultado) return toast("Error arqueo",false);
  toast("Caja cerrada ‚úîÔ∏è");
  actualizarSaldo();cargarMovimientos();
  showView("view-movimientos",document.querySelector(".nav-btns .nav-btn"));
}

// ===========================
function gid(id){return document.getElementById(id);}
</script>

</body>
</html>

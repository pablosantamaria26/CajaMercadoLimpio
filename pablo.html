<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Due√±o - Mercado Limpio</title>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Chart.js para tendencias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* =========================================
           ESTILOS V9: FUSI√ìN Y CORRECCIONES UI
           ========================================= */
        :root {
            --bg-body: #0f172a;      
            --bg-card: #1e293b;      
            --bg-header: rgba(15, 23, 42, 0.95);
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --primary: #3b82f6;      
            --success: #10b981;      
            --danger: #ef4444;      
            --warning: #f59e0b;      
            --purple: #8b5cf6;      
            --info: #06b6d4; 
            --accent: #ec4899;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            padding-top: calc(130px + var(--safe-top)); 
            padding-bottom: calc(90px + var(--safe-bottom));
            min-height: 100vh;
            overflow-x: hidden; /* Evita scroll lateral por animaciones */
        }

        /* --- HEADER --- */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            z-index: 1000;
            padding-top: var(--safe-top);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header-content {
            padding: 10px 15px;
            display: flex; flex-direction: column; gap: 12px;
        }

        .top-row {
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-logo { 
            font-size: 1.2rem; font-weight: 900; color: var(--text-main); 
            display: flex; align-items: center; gap: 8px; 
            letter-spacing: -0.5px;
        }

        /* DATE CONTROLS */
        .date-navigator {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05);
            border-radius: 14px;
            padding: 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .date-btn {
            background: transparent; border: none; color: var(--text-main);
            width: 44px; height: 40px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .date-btn:active { background: rgba(255,255,255,0.15); transform: scale(0.9); }
        
        .date-display-container {
            flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
            position: relative; height: 40px;
        }
        .date-text { font-weight: 700; font-size: 1rem; }
        
        #date-picker {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; z-index: 10;
        }

        /* --- TABS --- */
        .tabs-scroller {
            display: flex; gap: 8px; overflow-x: auto; padding: 0 15px 12px 15px;
            scrollbar-width: none; 
        }
        .tabs-scroller::-webkit-scrollbar { display: none; }
        
        .tab-chip {
            background: rgba(255,255,255,0.05); 
            color: var(--text-muted);
            padding: 9px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            white-space: nowrap; transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .tab-chip.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        /* --- SCREENS --- */
        .screen { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS --- */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
            position: relative; overflow: hidden;
        }
        .card-title {
            font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.8px; margin-bottom: 15px; font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- KPI GRIDS --- */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .kpi-box { 
            background: rgba(255,255,255,0.03); padding: 16px; border-radius: 16px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.02);
        }
        .kpi-val { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 2px;}
        .kpi-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;}

        .balance-hero { text-align: center; padding: 10px 0 20px 0; }
        .balance-amount { font-size: 2.8rem; font-weight: 900; letter-spacing: -1px; padding: 5px 0; }
        .balance-subtitle { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase;}

        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-info { color: var(--info); }

        /* --- LISTAS --- */
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 12px; border-radius: 12px;
            background: rgba(255,255,255,0.02);
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.02);
        }
        .row-icon {
            width: 40px; height: 40px; border-radius: 10px; background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center; margin-right: 12px;
            flex-shrink: 0;
        }
        .row-info { flex-grow: 1; min-width: 0; }
        .row-title { font-weight: 600; font-size: 0.95rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .row-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .row-amount { font-weight: 700; font-size: 0.95rem; white-space: nowrap; }

        /* --- FORMS & INPUTS (CORREGIDO PARA GASTOS FIJOS) --- */
        .input-dark {
            width: 100%; padding: 14px; margin-bottom: 12px;
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.1);
            color: white; border-radius: 12px; outline: none;
            font-family: 'Inter', sans-serif; font-size: 1rem;
            transition: border-color 0.2s;
        }
        .input-dark:focus { border-color: var(--primary); }
        .input-dark::placeholder { color: rgba(255,255,255,0.3); }

        .btn-main-action {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            border: none; border-radius: 12px;
            color: white; font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-main-action:active { transform: scale(0.98); }
        
        .btn-add-block {
            width: 100%; padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px dashed rgba(255,255,255,0.2);
            color: var(--text-muted); border-radius: 12px;
            font-weight: 600; margin-top: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .add-form { display: none; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .add-form.active { display: block; animation: fadeIn 0.2s; }

        /* --- COMBUSTIBLE (MEJORADO) --- */
        .fuel-vehicle-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border-radius: 16px; padding: 16px; 
            margin: 0 15px 12px 15px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s;
        }
        .fuel-vehicle-card:active { background: rgba(255,255,255,0.08); }
        .fuel-total { color: var(--warning); font-weight: 800; font-size: 1.1rem; }
        
        /* Lista detallada de cargas */
        .fuel-details-list {
            display: none; 
            margin: -8px 15px 12px 15px; 
            padding: 5px 15px 15px 15px;
            background: rgba(0,0,0,0.2);
            border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05); border-top: none;
        }
        .fuel-row {
            display: flex; justify-content: space-between; 
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem; color: var(--text-muted);
        }
        .fuel-row:last-child { border-bottom: none; }

        /* --- EMPLEADOS & FIJOS ITEMS --- */
        .emp-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.03); padding: 12px 15px;
            border-radius: 14px; border: 1px solid rgba(255,255,255,0.02);
        }
        .emp-input-mini {
            background: transparent; border: none; color: var(--success);
            font-weight: 800; font-size: 1.1rem; text-align: right; width: 80px;
            outline: none;
        }
        .btn-save-mini {
            width: 34px; height: 34px; border-radius: 8px; border: none;
            background: rgba(255,255,255,0.1); color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; margin-left: 8px;
            cursor: pointer;
        }

        /* --- ALERTAS --- */
        .alert-box {
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            border-left: 4px solid; background: rgba(255,255,255,0.03);
        }
        
        /* --- FAB REFRESH --- */
        .fab-container { position: fixed; bottom: 30px; right: 20px; z-index: 900; }
        .fab-refresh {
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white; border: none;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .fab-refresh:active { transform: scale(0.9); }

        .spin { animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 30px; color: var(--text-muted); opacity: 0.7; }
        
        /* Gr√°ficos */
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 10px; }

    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header-fixed">
        <div class="header-content">
            <div class="top-row">
                <div class="app-logo">
                    <span class="material-icons-round" style="color:var(--primary)">analytics</span> 
                    Control Due√±o
                </div>
                <div style="font-size:0.75rem; font-weight:700; color:var(--success); background:rgba(16,185,129,0.15); padding:6px 10px; border-radius:20px; display:flex; align-items:center; gap:4px;">
                    <span style="font-size:8px;">‚óè</span> ONLINE
                </div>
            </div>
            
            <!-- FECHAS (CON SWIPE LOGIC) -->
            <div class="date-navigator">
                <button class="date-btn" onclick="changeDate(-1)"><span class="material-icons-round">chevron_left</span></button>
                <div class="date-display-container">
                    <span class="material-icons-round" style="color:var(--primary); font-size:18px;">calendar_today</span>
                    <span id="date-label" class="date-text">Hoy</span>
                    <input type="date" id="date-picker" onchange="onDatePick(this.value)">
                </div>
                <button class="date-btn" onclick="changeDate(1)"><span class="material-icons-round">chevron_right</span></button>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs-scroller">
            <div class="tab-chip active" onclick="showScreen('resumen', this)">üìä Resumen</div>
            <div class="tab-chip" onclick="showScreen('tendencias', this)">üìà Tendencias</div>
            <div class="tab-chip" onclick="showScreen('movimientos', this)">üìù Movimientos</div>
            <div class="tab-chip" onclick="showScreen('combustible', this)">‚õΩ Combustible</div>
            <div class="tab-chip" onclick="showScreen('empleados', this)">üë• Empleados</div>
            <div class="tab-chip" onclick="showScreen('fijos', this)">üè† G. Fijos</div>
            <div class="tab-chip" onclick="showScreen('proveedores', this)">üöö Proveedores</div>
            <div class="tab-chip" onclick="showScreen('alertas', this)">üö® Alertas</div>
        </div>
    </div>

    <!-- AREA DE CONTENIDO (SWIPEABLE) -->
    <div id="main-content-area">

        <!-- 1. RESUMEN -->
        <div id="screen-resumen" class="screen active">
            <div class="card">
                <div class="balance-hero">
                    <div class="balance-subtitle">Resultado Operativo (D√≠a)</div>
                    <div class="balance-amount" id="kpi-neto">--</div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-box">
                        <div class="kpi-val text-green" id="kpi-ingreso">--</div>
                        <div class="kpi-lbl">Ingresos</div>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-val text-red" id="kpi-egreso">--</div>
                        <div class="kpi-lbl">Egresos</div>
                    </div>
                </div>
                
                <div class="card-title" style="margin-top:20px;">
                    <span>Caja F√≠sica</span>
                    <span class="material-icons-round" style="font-size:16px;">verified_user</span>
                </div>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                    <div class="kpi-box" style="padding:10px;">
                        <div class="kpi-val" style="font-size:1.1rem;" id="kpi-caja-efectivo">--</div>
                        <div class="kpi-lbl">EFECTIVO</div>
                    </div>
                    <div class="kpi-box" style="padding:10px;">
                        <div class="kpi-val" style="font-size:1.1rem; color:var(--purple);" id="kpi-caja-cheques">--</div>
                        <div class="kpi-lbl">CHEQUES</div>
                    </div>
                    <div class="kpi-box" style="padding:10px; background:var(--primary); border:none;">
                        <div class="kpi-val" style="font-size:1.1rem; color:white;" id="kpi-caja-total">--</div>
                        <div class="kpi-lbl" style="color:white; opacity:0.8;">TOTAL</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1.5 TENDENCIAS (NUEVO) -->
        <div id="screen-tendencias" class="screen">
             <div class="card">
                <div class="card-title">
                    <span>Evoluci√≥n Egresos (7 D√≠as)</span>
                    <span class="material-icons-round">show_chart</span>
                </div>
                <div class="chart-container">
                    <canvas id="chartEgresos"></canvas>
                </div>
             </div>
             <div class="card">
                <div class="card-title">
                    <span>Ranking de Gastos</span>
                    <span class="material-icons-round">pie_chart</span>
                </div>
                <div class="chart-container">
                    <canvas id="chartRanking"></canvas>
                </div>
             </div>
        </div>

        <!-- 2. MOVIMIENTOS -->
        <div id="screen-movimientos" class="screen">
            <div class="card">
                <div class="card-title">
                    <span>Historial del D√≠a</span>
                    <span id="mov-count" style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:0.75rem;">0</span>
                </div>
                <div id="movimientos-list">
                    <div class="empty-state">Cargando...</div>
                </div>
            </div>
        </div>

        <!-- 3. COMBUSTIBLE (MEJORADO) -->
        <div id="screen-combustible" class="screen" style="padding: 15px 0;">
             <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border:none; margin: 0 15px 16px 15px;">
                <div style="color:white; opacity:0.9; font-size:0.8rem; font-weight:700; margin-bottom:5px;">TOTAL COMBUSTIBLE (D√çA)</div>
                <div style="color:white; font-size:2.8rem; font-weight:800; line-height:1.1;" id="fuel-day-total">$ 0</div>
            </div>
            <div class="card-title" style="padding:0 30px; margin-top:10px;">DESGLOSE POR VEH√çCULO</div>
            <div id="fuel-container">
                <div class="empty-state" style="margin:0 15px;">Sin cargas hoy.</div>
            </div>
        </div>

        <!-- 4. EMPLEADOS -->
        <div id="screen-empleados" class="screen">
            <div class="card">
                <div class="card-title"><span>Configuraci√≥n Sueldos</span> <span class="material-icons-round">badge</span></div>
                <div id="empleados-list" style="display:grid; gap:10px;"></div>
                
                <button class="btn-add-block" onclick="toggleAddForm('emp')">
                    <span class="material-icons-round">add</span> Nuevo Empleado
                </button>
                <div id="add-emp-form" class="add-form">
                    <input type="text" id="new-emp-name" class="input-dark" placeholder="Nombre (ej: Juan)">
                    <input type="number" id="new-emp-wage" class="input-dark" placeholder="Sueldo Base ($)">
                    <button class="btn-main-action" onclick="addNewEmpleado()">
                        <span class="material-icons-round">save</span> Guardar Empleado
                    </button>
                </div>
            </div>
        </div>

        <!-- 5. GASTOS FIJOS (UI CORREGIDA) -->
        <div id="screen-fijos" class="screen">
            <div class="card" style="border-left: 4px solid var(--info);">
                <div class="card-title" style="color:var(--info);">
                    <span>Gastos Fijos Mensuales</span>
                    <span class="material-icons-round">apartment</span>
                </div>
                <div id="fijos-list" style="display:grid; gap:10px;"></div>

                <div style="background:rgba(6,182,212,0.1); padding:15px; border-radius:12px; margin-top:16px;">
                    <div style="font-size:0.8rem; color:var(--text-muted); font-weight:700; margin-bottom:5px;">TOTAL PROYECTADO MENSUAL</div>
                    <div style="font-size:1.8rem; font-weight:900; color:var(--info);" id="total-fijos-mensual">--</div>
                </div>

                <button class="btn-add-block" onclick="toggleAddForm('fijo')">
                    <span class="material-icons-round">add_circle_outline</span> Nuevo Gasto Fijo
                </button>
                
                <!-- FORMULARIO CON ESTILO INPUT-DARK CORREGIDO -->
                <div id="add-fijo-form" class="add-form">
                    <input type="text" id="new-fijo-name" class="input-dark" placeholder="Nombre (ej: Alquiler)">
                    <input type="number" id="new-fijo-amount" class="input-dark" placeholder="Costo Mensual ($)">
                    <button class="btn-main-action" style="background:var(--info);" onclick="addNewGastoFijo()">
                        <span class="material-icons-round">save</span> Guardar Gasto
                    </button>
                </div>
            </div>
        </div>

        <!-- 6. PROVEEDORES -->
        <div id="screen-proveedores" class="screen">
             <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border:none;">
                <div style="color:white; opacity:0.9; font-size:0.8rem; font-weight:700; margin-bottom:5px;">PAGOS PROVEEDORES</div>
                <div style="color:white; font-size:2.8rem; font-weight:800; line-height:1.1;" id="prov-day-total">$ 0</div>
            </div>
            <div class="card">
                <div id="prov-list"><div class="empty-state">Sin pagos hoy.</div></div>
            </div>
        </div>

        <!-- 7. ALERTAS -->
        <div id="screen-alertas" class="screen">
            <div class="card">
                <div class="card-title">Centro de Alertas</div>
                <div id="alerts-list"></div>
            </div>
        </div>

    </div> <!-- Fin Swipe Area -->

    <!-- FAB -->
    <div class="fab-container">
        <button class="fab-refresh" onclick="forceRefresh()"><span class="material-icons-round" style="font-size:26px;">sync</span></button>
    </div>

    <script>
        // === CONFIGURACI√ìN ===
        const API_URL = "https://cajamercadolimpio.santamariapablodaniel.workers.dev/";
        const apiKey = ""; 

        // === ESTADO ===
        let currentDateStr = "";
        let currentMovs = [];
        let fuelMovsByVehicle = {};
        
        // Gr√°ficos
        let chartEgresos = null;
        let chartRanking = null;

        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            const offset = today.getTimezoneOffset() * 60000;
            const localIso = new Date(today.getTime() - offset).toISOString().split('T')[0];
            
            setDate(localIso);
            fetchStatusCaja();
            fetchEmpleados();
            fetchGastosFijos();
            initSwipe(); // Iniciar detector de deslizamiento
        });

        // === FECHAS ===
        function setDate(isoDate) {
            currentDateStr = isoDate;
            const picker = document.getElementById('date-picker');
            if(picker) picker.value = isoDate;
            
            const d = new Date(isoDate + "T12:00:00");
            const today = new Date(); today.setHours(12,0,0,0);
            const diff = Math.round((d - today) / (1000 * 60 * 60 * 24));
            
            let label = d.toLocaleDateString('es-AR', {day:'numeric', month:'short'});
            if(diff === 0) label = "Hoy";
            else if(diff === -1) label = "Ayer";
            else if(diff === 1) label = "Ma√±ana";
            
            document.getElementById('date-label').textContent = label;
            
            // CARGA DE DATOS CR√çTICA (USANDO L√ìGICA V4 "PERFECTA")
            fetchDataForDate(currentDateStr);
            
            // Carga diferida de tendencias para no bloquear
            if(document.getElementById('screen-tendencias').classList.contains('active')){
                loadTrendsData();
            }
        }

        function changeDate(delta) {
            const d = new Date(currentDateStr + "T12:00:00");
            d.setDate(d.getDate() + delta);
            setDate(d.toISOString().split('T')[0]);
        }
        function onDatePick(val) { if(val) setDate(val); }

        // === DATA FETCHING (L√ìGICA V4 RESTAURADA) ===
        async function api(fn, params = {}) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({fn, params})
                });
                return await res.json();
            } catch (e) { console.error(e); return null; }
        }

        async function fetchDataForDate(dateStr) {
            const listEl = document.getElementById('movimientos-list');
            listEl.style.opacity = '0.5';
            
            // Usamos getMovimientos EXACTO (sin rango) para asegurar consistencia
            const fechaSegura = dateStr + "T12:00:00";
            const res = await api("getMovimientos", { fechaStr: fechaSegura });
            
            listEl.style.opacity = '1';
            
            if(Array.isArray(res)) {
                currentMovs = res;
            } else {
                currentMovs = [];
            }
            processData(); // Procesa la lista localmente
        }

        function processData() {
            let ingresos = 0, egresos = 0;
            const fuelMap = { total: 0, vehicles: {} };
            const provMap = { total: 0, list: [] };
            const alerts = [];
            fuelMovsByVehicle = {}; 

            currentMovs.forEach(m => {
                const imp = Number(m.importe) || 0;
                const cat = (m.categoria || "").toLowerCase();
                const obs = (m.observacion || "").toLowerCase();
                
                if(m.tipo === 'Ingreso') ingresos += imp; else egresos += imp;

                // COMBUSTIBLE
                if(cat.includes('combustible')) {
                    fuelMap.total += imp;
                    let veh = m.vehiculo || "Otros";
                    if (veh === "Otros" || veh === "") {
                         if(cat.includes('saveiro') || obs.includes('saveiro')) veh = "Volkswagen Saveiro";
                         else if(cat.includes('toyota') || obs.includes('toyota') || cat.includes('hiace')) veh = "Toyota Hiace";
                         else if(cat.includes('fiat') || cat.includes('uno') || obs.includes('uno')) veh = "Fiat Uno Cargo";
                    }
                    if(!fuelMap.vehicles[veh]) fuelMap.vehicles[veh] = { count: 0, total: 0 };
                    fuelMap.vehicles[veh].count++;
                    fuelMap.vehicles[veh].total += imp;

                    if (!fuelMovsByVehicle[veh]) fuelMovsByVehicle[veh] = [];
                    fuelMovsByVehicle[veh].push({ amount: imp, time: m.hora, date: m.fecha }); 
                }

                // PROVEEDORES
                if(cat.includes('proveedor')) {
                    provMap.total += imp;
                    let name = m.proveedor || obs.replace('pago a ', '').trim() || m.categoria;
                    const provMatch = obs.match(/\[Prov: (.*?)\]/i);
                    if(provMatch && provMatch[1]) name = provMatch[1];
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                    provMap.list.push({ name, amount: imp, time: m.hora });
                }

                // ALERTAS
                if(cat.includes('diferencia') || obs.includes('faltante') || obs.includes('sobrante')) {
                    if(Math.abs(imp) > 1000) alerts.push({ type: 'danger', title: 'Diferencia Caja', msg: `${m.categoria}: ${formatMoney(imp)}` });
                }
            });

            // KPIs
            const neto = ingresos - egresos;
            document.getElementById('kpi-ingreso').textContent = formatMoney(ingresos);
            document.getElementById('kpi-egreso').textContent = formatMoney(egresos);
            const netoEl = document.getElementById('kpi-neto');
            netoEl.textContent = formatMoney(neto);
            netoEl.className = `balance-amount ${neto >= 0 ? 'text-green' : 'text-red'}`;

            // RENDER LISTAS
            renderMovsList(currentMovs);
            renderFuel(fuelMap);
            renderProv(provMap);
            renderAlerts(alerts);
        }

        // === RENDERERS ===
        function renderMovsList(list) {
            const container = document.getElementById('movimientos-list');
            document.getElementById('mov-count').textContent = list.length;
            if(list.length === 0) { container.innerHTML = '<div class="empty-state">Sin movimientos.</div>'; return; }
            let html = '';
            list.forEach(m => {
                const isIng = m.tipo === 'Ingreso';
                const color = isIng ? 'text-green' : 'text-red';
                const sign = isIng ? '+' : '-';
                const icon = getIconForCategory(m.categoria);
                const subText = `${(m.hora||"").substring(0,5)} hs ‚Ä¢ ${m.formaPago}`;
                html += `
                <div class="list-row">
                    <div style="display:flex; align-items:center; overflow:hidden;">
                        <div class="row-icon"><span class="material-icons-round" style="color:${isIng?'var(--success)':'var(--text-muted)'}">${icon}</span></div>
                        <div class="row-info">
                            <div class="row-title">${m.categoria}</div>
                            <div class="row-sub">${subText}</div>
                        </div>
                    </div>
                    <div class="row-amount ${color}">${sign} ${formatMoney(m.importe).replace('$ ','')}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // RENDER COMBUSTIBLE MEJORADO (Detalle no desaparece)
        function renderFuel(map) {
            document.getElementById('fuel-day-total').textContent = formatMoney(map.total);
            const container = document.getElementById('fuel-container');
            if(map.total === 0) { container.innerHTML = '<div class="empty-state" style="margin:0 15px;">Sin gastos.</div>'; return; }
            
            let html = '';
            for (const [v, data] of Object.entries(map.vehicles)) {
                const id = v.replace(/[^a-zA-Z0-9]/g, ''); // ID seguro
                html += `
                <div>
                    <div class="fuel-vehicle-card" onclick="toggleFuel('${id}')">
                        <div style="font-weight:700;"><span class="material-icons-round" style="vertical-align:middle; margin-right:5px; color:var(--warning);">local_shipping</span> ${v}</div>
                        <div style="text-align:right;">
                            <div class="fuel-total">${formatMoney(data.total)}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${data.count} carga(s)</div>
                        </div>
                    </div>
                    <div id="fuel-det-${id}" class="fuel-details-list">
                        ${renderFuelDetailsRows(fuelMovsByVehicle[v] || [])}
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function renderFuelDetailsRows(movs) {
            return movs.map(m => `
                <div class="fuel-row">
                    <span>${(m.time||"").substring(0,5)} hs</span>
                    <span class="text-red" style="font-weight:700;">${formatMoney(m.amount)}</span>
                </div>
            `).join('');
        }

        // Funci√≥n Toggle simple y robusta
        window.toggleFuel = (id) => {
            const el = document.getElementById(`fuel-det-${id}`);
            if(el.style.display === 'block') el.style.display = 'none';
            else el.style.display = 'block';
        };

        function renderProv(map) {
            document.getElementById('prov-day-total').textContent = formatMoney(map.total);
            const container = document.getElementById('prov-list');
            if(map.list.length === 0) { container.innerHTML = '<div class="empty-state">Sin pagos.</div>'; return; }
            container.innerHTML = map.list.map(p => `
                <div class="list-row">
                    <div style="display:flex; align-items:center;">
                        <div class="row-icon" style="background:rgba(139, 92, 246, 0.1); color:var(--purple);"><span class="material-icons-round">local_shipping</span></div>
                        <div class="row-info"><div class="row-title">${p.name}</div><div class="row-sub">${p.time} hs</div></div>
                    </div>
                    <div class="row-amount text-red">- ${formatMoney(p.amount).replace('$ ','')}</div>
                </div>
            `).join('');
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alerts-list');
            if(alerts.length === 0) { container.innerHTML = '<div class="empty-state">‚úÖ Todo normal.</div>'; return; }
            container.innerHTML = alerts.map(a => `
                <div class="alert-box" style="border-color:${a.type==='danger'?'var(--danger)':'var(--warning)'}">
                    <div style="font-weight:700; color:${a.type==='danger'?'var(--danger)':'var(--warning)'}; margin-bottom:5px;">${a.title}</div>
                    <div style="color:var(--text-muted); font-size:0.9rem;">${a.msg}</div>
                </div>
            `).join('');
        }

        // === SWIPE LOGIC ===
        function initSwipe() {
            let startX = 0;
            const content = document.getElementById('main-content-area');
            
            content.addEventListener('touchstart', e => {
                startX = e.changedTouches[0].screenX;
            }, {passive: true});

            content.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].screenX;
                const diff = endX - startX;
                if (Math.abs(diff) > 80) { // Umbral de swipe
                    if (diff > 0) changeDate(-1); // Swipe derecha -> d√≠a anterior
                    else changeDate(1); // Swipe izquierda -> d√≠a siguiente
                }
            }, {passive: true});
        }

        // === GASTOS FIJOS (API & UI) ===
        async function fetchGastosFijos() {
            const container = document.getElementById('fijos-list');
            const res = await api("getConfigGastosFijos");
            if (!res || !res.ok) return;
            
            const list = res.data || [];
            let total = 0;
            container.innerHTML = list.map(g => {
                total += parseInt(g.montoMensual)||0;
                return `
                <div class="emp-item" style="border-left:4px solid var(--info);">
                    <div style="flex:1;">
                        <div style="font-weight:700; font-size:1rem;">${g.nombre}</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">Mensual</div>
                    </div>
                    <input type="number" class="emp-input-mini" style="color:var(--info);" id="fijo-${g.nombre.replace(/\s/g,'-')}" value="${g.montoMensual}">
                    <button class="btn-save-mini" onclick="saveGastoFijo('${g.nombre}')"><span class="material-icons-round" style="font-size:18px;">save</span></button>
                </div>`;
            }).join('');
            document.getElementById('total-fijos-mensual').textContent = formatMoney(total);
        }

        async function saveGastoFijo(nombre) {
             const input = document.getElementById(`fijo-${nombre.replace(/\s/g,'-')}`);
             const val = parseInt(input.value) || 0;
             const btn = input.nextElementSibling;
             
             btn.innerHTML = '<span class="spin material-icons-round" style="font-size:18px">sync</span>';
             await api("updateConfigGastoFijo", { nombre: nombre, montoMensual: val, lastUpdate: new Date().toISOString().split('T')[0] });
             btn.innerHTML = '<span class="material-icons-round" style="font-size:18px; color:var(--success);">check</span>';
             setTimeout(() => { 
                 btn.innerHTML = '<span class="material-icons-round" style="font-size:18px;">save</span>'; 
                 fetchGastosFijos(); 
             }, 1000);
        }

        async function addNewGastoFijo() {
            const name = document.getElementById('new-fijo-name').value;
            const amount = document.getElementById('new-fijo-amount').value;
            if(!name || !amount) return;
            
            const btn = document.querySelector('#add-fijo-form button');
            btn.innerHTML = "Guardando...";
            await api("addConfigGastoFijo", { nombre: name, montoMensual: parseInt(amount) });
            
            document.getElementById('new-fijo-name').value = "";
            document.getElementById('new-fijo-amount').value = "";
            toggleAddForm('fijo');
            fetchGastosFijos();
            btn.innerHTML = '<span class="material-icons-round">save</span> Guardar Gasto';
        }

        // === EMPLEADOS ===
        async function fetchEmpleados() {
             const container = document.getElementById('empleados-list');
             const res = await api("getConfigEmpleados");
             if(!res || !res.ok) return;
             
             container.innerHTML = (res.data || []).map(e => `
                <div class="emp-item" style="border-left:4px solid var(--primary);">
                    <div style="flex:1;">
                        <div style="font-weight:700;">${e.nombre}</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">Sueldo Base</div>
                    </div>
                    <input type="number" class="emp-input-mini" id="wage-${e.nombre.replace(/\s/g,'-')}" value="${e.sueldoBase}">
                    <button class="btn-save-mini" onclick="saveSueldo('${e.nombre}')"><span class="material-icons-round" style="font-size:18px;">save</span></button>
                </div>
             `).join('');
        }
        
        async function saveSueldo(nombre) {
            const input = document.getElementById(`wage-${nombre.replace(/\s/g,'-')}`);
            const val = parseInt(input.value) || 0;
            const btn = input.nextElementSibling;
            btn.innerHTML = '<span class="spin material-icons-round">sync</span>';
            await api("updateConfigEmpleado", {nombre, sueldoBase: val, lastUpdate: new Date().toISOString().split('T')[0]});
            btn.innerHTML = '<span class="material-icons-round" style="color:var(--success);">check</span>';
            setTimeout(() => { btn.innerHTML = '<span class="material-icons-round">save</span>'; }, 1000);
        }
        
        async function addNewEmpleado() {
            const name = document.getElementById('new-emp-name').value;
            const wage = document.getElementById('new-emp-wage').value;
            if(!name || !wage) return;
            await api("addConfigEmpleado", {nombre: name, sueldoBase: parseInt(wage)});
            toggleAddForm('emp');
            fetchEmpleados();
        }

        // === TENDENCIAS (Background) ===
        async function loadTrendsData() {
            if(chartEgresos) return; // Ya cargado
            // Pedimos 7 d√≠as atr√°s
            const d = new Date(currentDateStr + "T12:00:00");
            const end = currentDateStr;
            d.setDate(d.getDate() - 6);
            const start = d.toISOString().split('T')[0];
            
            const res = await api("getMovimientosRango", {startDateStr: start, endDateStr: end});
            if(res && res.ok && res.data) {
                renderTrendsCharts(res.data);
            }
        }
        
        function renderTrendsCharts(data) {
            // Procesar data para agrupar por fecha
            const days = {};
            const cats = {};
            
            data.forEach(m => {
                if(m.tipo === 'Egreso') {
                    if(!days[m.fecha]) days[m.fecha] = 0;
                    days[m.fecha] += parseInt(m.importe);
                    
                    if(!cats[m.categoria]) cats[m.categoria] = 0;
                    cats[m.categoria] += parseInt(m.importe);
                }
            });
            
            // Render Chart Egresos
            const ctx1 = document.getElementById('chartEgresos');
            if(ctx1) {
                chartEgresos = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: Object.keys(days).sort().map(d => d.substring(5)), // MM-DD
                        datasets: [{
                            label: 'Egresos',
                            data: Object.keys(days).sort().map(k => days[k]),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true, tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: { x: {grid:{display:false}, ticks:{color:'#94a3b8'}}, y: {grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#94a3b8'}} } }
                });
            }
            
            // Render Ranking
            const sortedCats = Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctx2 = document.getElementById('chartRanking');
            if(ctx2) {
                chartRanking = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCats.map(x=>x[0]),
                        datasets: [{
                            data: sortedCats.map(x=>x[1]),
                            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{position:'right', labels:{color:'#94a3b8', font:{size:10}}}} }
                });
            }
        }

        // === UTILS ===
        function fetchStatusCaja() {
            api("getEstadoCaja").then(res => {
                if(res) {
                    const ef = parseInt(res.efectivo||0), ch = parseInt(res.cheques||0);
                    document.getElementById('kpi-caja-efectivo').textContent = formatMoney(ef);
                    document.getElementById('kpi-caja-cheques').textContent = formatMoney(ch);
                    document.getElementById('kpi-caja-total').textContent = formatMoney(ef+ch);
                }
            });
        }
        
        function showScreen(id, tab) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-'+id).classList.add('active');
            if(tab) {
                document.querySelectorAll('.tab-chip').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            }
            if(id === 'tendencias') loadTrendsData();
        }
        
        function toggleAddForm(type) {
            const f = document.getElementById(type === 'emp' ? 'add-emp-form' : 'add-fijo-form');
            f.classList.toggle('active');
        }

        function formatMoney(n) { return "$ " + Number(n).toLocaleString('es-AR'); }
        function getIconForCategory(c) {
            c = (c||"").toLowerCase();
            if(c.includes('combustible')) return 'local_gas_station';
            if(c.includes('proveedor')) return 'local_shipping';
            if(c.includes('sueldo')||c.includes('haberes')) return 'badge';
            return 'paid';
        }
        function forceRefresh() { 
            const i = document.querySelector('.fab-refresh span'); i.classList.add('spin');
            setDate(currentDateStr); fetchStatusCaja();
            setTimeout(() => i.classList.remove('spin'), 800);
        }

    </script>
</body>
</html>

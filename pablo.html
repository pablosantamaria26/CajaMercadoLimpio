<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dueño - Mercado Limpio</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* =========================================
           ESTILOS V10: FINTECH PRO - DARK MODE
           ========================================= */
        :root {
            --bg-body: #0b0e14;       /* Negro profundo */
            --bg-card: #151a23;       /* Gris azulado muy oscuro */
            --bg-header: rgba(11, 14, 20, 0.85);
            
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            
            --primary: #3b82f6;       
            --primary-glow: rgba(59, 130, 246, 0.4);
            --success: #10b981;       
            --danger: #ef4444;       
            --warning: #f59e0b;       
            --info: #06b6d4;          /* Color principal para Gastos Fijos */
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            padding-top: calc(120px + var(--safe-top)); 
            padding-bottom: calc(90px + var(--safe-bottom));
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--bg-header);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 1000;
            padding-top: var(--safe-top);
        }
        
        .header-content { padding: 10px 20px; }

        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .app-logo { 
            font-size: 1.1rem; font-weight: 800; color: var(--text-main); 
            display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px;
        }

        /* DATE NAVIGATOR REFINADO */
        .date-navigator {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 50px;
            padding: 4px 6px;
            border: 1px solid rgba(255,255,255,0.08);
            width: 100%; max-width: 320px; margin: 0 auto;
        }
        .date-btn {
            background: transparent; border: none; color: var(--text-muted);
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .date-btn:active { background: rgba(255,255,255,0.1); color: white; }
        
        .date-display-container {
            position: relative; display: flex; align-items: center; gap: 8px;
        }
        .date-text { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }
        #date-picker { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; }

        /* --- TABS --- */
        .tabs-scroller {
            display: flex; gap: 15px; overflow-x: auto; padding: 0 20px 15px 20px;
            scrollbar-width: none; 
        }
        .tabs-scroller::-webkit-scrollbar { display: none; }
        
        .tab-chip {
            background: transparent; 
            color: var(--text-muted);
            padding: 8px 0; 
            font-size: 0.9rem; font-weight: 600;
            white-space: nowrap; transition: all 0.2s;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            opacity: 0.7;
        }
        .tab-chip.active {
            color: var(--primary); 
            border-bottom: 2px solid var(--primary);
            opacity: 1;
        }

        /* --- CARDS & UI --- */
        .screen { display: none; padding: 20px; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.03);
            position: relative; overflow: hidden;
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
            font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- HERO BALANCE --- */
        .hero-card {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            text-align: center; padding-top: 30px; padding-bottom: 30px;
        }
        .balance-amount { 
            font-size: 3.2rem; font-weight: 800; letter-spacing: -2px; 
            padding: 0; margin: 10px 0;
            font-variant-numeric: tabular-nums; 
            background: -webkit-linear-gradient(90deg, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .balance-amount.text-green { 
            background: -webkit-linear-gradient(90deg, #34d399, #10b981); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .balance-amount.text-red { 
            background: -webkit-linear-gradient(90deg, #f87171, #ef4444); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }

        /* --- KPI PILLS --- */
        .kpi-row { display: flex; gap: 15px; margin-top: 25px; }
        .kpi-pill {
            flex: 1; background: rgba(255,255,255,0.03);
            border-radius: 16px; padding: 12px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.02);
        }
        .kpi-pill-val { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; color: white; }
        .kpi-pill-lbl { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

        /* --- WIDGET CAJA FÍSICA --- */
        .physical-money-widget {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 20px; padding: 20px; color: white;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
            position: relative; overflow: hidden;
        }
        .physical-money-widget::before {
            content:''; position: absolute; top:-50%; right:-20%; width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius: 50%;
        }
        .pm-label { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .pm-total { font-size: 2.2rem; font-weight: 800; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; }
        .pm-breakdown { display: flex; gap: 15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }
        .pm-item { flex: 1; }
        .pm-item-val { font-weight: 700; font-size: 1rem; }
        .pm-item-lbl { font-size: 0.7rem; opacity: 0.7; }

        /* --- ESTILOS ESPECIALES GASTOS FIJOS --- */
        .fixed-hero {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.02) 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
            text-align: center; padding: 25px;
        }
        .fixed-total { 
            font-size: 2.5rem; font-weight: 900; color: var(--info); 
            margin: 10px 0; letter-spacing: -1px; text-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }
        
        /* Lista Limpia */
        .clean-list { display: flex; flex-direction: column; }
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .list-row:last-child { border-bottom: none; }
        
        .row-icon {
            width: 42px; height: 42px; border-radius: 12px; 
            background: rgba(255,255,255,0.05); color: var(--text-main);
            display: flex; align-items: center; justify-content: center; margin-right: 15px;
        }
        .row-info { flex: 1; }
        .row-title { font-size: 1rem; font-weight: 600; margin-bottom: 2px; }
        .row-sub { font-size: 0.8rem; color: #64748b; }
        
        /* Input invisible para editar montos en lista */
        .clean-input {
            background: transparent; border: 1px solid transparent;
            color: var(--text-main); font-weight: 700; font-size: 1rem;
            text-align: right; width: 100px; padding: 5px;
            border-radius: 8px; outline: none; transition: all 0.2s;
            font-family: 'Inter';
        }
        .clean-input:focus {
            background: rgba(255,255,255,0.1);
            border-color: var(--info);
        }
        .clean-input:focus + .mini-save-btn { opacity: 1; transform: translateX(0); }

        .mini-save-btn {
            background: var(--info); color: white; border: none;
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            margin-left: 8px; cursor: pointer;
            opacity: 0.5; transition: all 0.2s;
        }

        /* --- BOTONES & FORMULARIOS --- */
        .btn-add-floating {
            width: 100%; padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px dashed rgba(255,255,255,0.2);
            color: var(--text-muted); border-radius: 16px;
            font-weight: 600; margin-top: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-add-floating:hover, .btn-add-floating:active {
            background: rgba(255,255,255,0.08); color: white; border-color: rgba(255,255,255,0.4);
        }

        .add-form { 
            display: none; background: #0f1218; padding: 20px; 
            border-radius: 20px; margin-top: 15px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .add-form.active { display: block; animation: fadeIn 0.3s; }
        
        .input-pro {
            width: 100%; padding: 16px; margin-bottom: 15px;
            background: rgba(255,255,255,0.03); 
            border: 1px solid rgba(255,255,255,0.1);
            color: white; border-radius: 14px; outline: none;
            font-family: 'Inter'; font-size: 1rem;
        }
        .input-pro:focus { border-color: var(--info); background: rgba(255,255,255,0.05); }
        
        .btn-primary-action {
            width: 100%; padding: 16px;
            background: var(--info); color: white;
            border: none; border-radius: 14px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.3);
        }

        /* FAB REFRESH */
        .fab-container { position: fixed; bottom: 30px; right: 20px; z-index: 900; }
        .fab-refresh {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--bg-card); color: var(--text-main); 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .fab-refresh:active { transform: scale(0.9); }
        .spin { animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 30px; color: var(--text-muted); opacity: 0.6; font-style: italic; }
        
        /* Utilidades texto */
        .text-green { color: #34d399; }
        .text-red { color: #f87171; }
        
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 10px; }

    </style>
</head>
<body>

    <div class="header-fixed">
        <div class="header-content">
            <div class="top-row">
                <div class="app-logo">
                    <span class="material-icons-round" style="color:var(--primary)">analytics</span> 
                    Control Dueño
                </div>
                <div style="font-size:0.75rem; font-weight:700; color:var(--success); background:rgba(16,185,129,0.15); padding:6px 12px; border-radius:20px; display:flex; align-items:center; gap:5px;">
                    <span style="font-size:8px;">●</span> ONLINE
                </div>
            </div>
            
            <div class="date-navigator">
                <button class="date-btn" onclick="changeDate(-1)"><span class="material-icons-round">chevron_left</span></button>
                <div class="date-display-container">
                    <span id="date-label" class="date-text">Hoy</span>
                    <input type="date" id="date-picker" onchange="onDatePick(this.value)">
                </div>
                <button class="date-btn" onclick="changeDate(1)"><span class="material-icons-round">chevron_right</span></button>
            </div>
        </div>

        <div class="tabs-scroller">
            <div class="tab-chip active" onclick="showScreen('resumen', this)">Resumen</div>
            <div class="tab-chip" onclick="showScreen('tendencias', this)">Tendencias</div>
            <div class="tab-chip" onclick="showScreen('movimientos', this)">Movimientos</div>
            <div class="tab-chip" onclick="showScreen('combustible', this)">Combustible</div>
            <div class="tab-chip" onclick="showScreen('fijos', this)" style="color:var(--info); border-color:var(--info); opacity:1;">Gastos Fijos</div>
            <div class="tab-chip" onclick="showScreen('empleados', this)">Empleados</div>
            <div class="tab-chip" onclick="showScreen('proveedores', this)">Proveedores</div>
            <div class="tab-chip" onclick="showScreen('alertas', this)">Alertas</div>
        </div>
    </div>

    <div id="main-content-area">

        <div id="screen-resumen" class="screen active">
            <div class="card hero-card">
                <div style="color:var(--text-muted); font-size:0.75rem; text-transform:uppercase; letter-spacing:2px; font-weight:700;">Resultado Operativo</div>
                <div class="balance-amount" id="kpi-neto">--</div>
                
                <div class="kpi-row">
                    <div class="kpi-pill">
                        <div class="kpi-pill-val text-green" id="kpi-ingreso">--</div>
                        <div class="kpi-pill-lbl">Ingresos</div>
                    </div>
                    <div class="kpi-pill">
                        <div class="kpi-pill-val text-red" id="kpi-egreso">--</div>
                        <div class="kpi-pill-lbl">Egresos</div>
                    </div>
                </div>
            </div>

            <div class="physical-money-widget">
                <div class="pm-label"><span class="material-icons-round" style="font-size:14px; vertical-align:middle;">lock</span> Caja Física Total</div>
                <div class="pm-total" id="kpi-caja-total">--</div>
                <div class="pm-breakdown">
                    <div class="pm-item">
                        <div class="pm-item-val" id="kpi-caja-efectivo">--</div>
                        <div class="pm-item-lbl">Efectivo</div>
                    </div>
                    <div class="pm-item">
                        <div class="pm-item-val" id="kpi-caja-cheques">--</div>
                        <div class="pm-item-lbl">Cheques</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-fijos" class="screen">
            <div class="card fixed-hero">
                <div style="font-size:0.8rem; color:var(--info); font-weight:700; text-transform:uppercase; letter-spacing:1px;">Proyección Mensual</div>
                <div class="fixed-total" id="total-fijos-mensual">--</div>
                <div style="font-size:0.8rem; opacity:0.7;">Suma total de gastos recurrentes</div>
            </div>

            <div class="card">
                <div class="card-header">Detalle de Gastos</div>
                <div id="fijos-list" class="clean-list">
                    <div class="empty-state">Cargando...</div>
                </div>

                <button class="btn-add-floating" onclick="toggleAddForm('fijo')">
                    <span class="material-icons-round">add</span> Agregar Nuevo Gasto
                </button>

                <div id="add-fijo-form" class="add-form">
                    <div style="margin-bottom:15px; font-weight:700; color:white;">Nuevo Gasto Fijo</div>
                    <input type="text" id="new-fijo-name" class="input-pro" placeholder="Nombre (ej: Alquiler Local)">
                    <input type="number" id="new-fijo-amount" class="input-pro" placeholder="Monto Mensual ($)">
                    <button class="btn-primary-action" onclick="addNewGastoFijo()">
                        Guardar Gasto
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-movimientos" class="screen">
            <div class="card">
                <div class="card-header">
                    <span>Historial del Día</span>
                    <span id="mov-count" style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:0.75rem; color:white;">0</span>
                </div>
                <div id="movimientos-list"></div>
            </div>
        </div>

        <div id="screen-tendencias" class="screen">
             <div class="card">
                <div class="card-header">Evolución Egresos (7 Días)</div>
                <div class="chart-container"><canvas id="chartEgresos"></canvas></div>
             </div>
             <div class="card">
                <div class="card-header">Ranking de Gastos</div>
                <div class="chart-container"><canvas id="chartRanking"></canvas></div>
             </div>
        </div>

        <div id="screen-combustible" class="screen">
             <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); text-align:center;">
                <div style="color:white; opacity:0.9; font-size:0.8rem; font-weight:700; margin-bottom:5px;">TOTAL COMBUSTIBLE (DÍA)</div>
                <div style="color:white; font-size:2.8rem; font-weight:800; line-height:1.1;" id="fuel-day-total">$ 0</div>
            </div>
            <div style="margin:20px 0 10px 10px; font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Desglose por Vehículo</div>
            <div id="fuel-container"></div>
        </div>

        <div id="screen-empleados" class="screen">
            <div class="card">
                <div class="card-header">Sueldos Base</div>
                <div id="empleados-list" class="clean-list"></div>
                
                <button class="btn-add-floating" onclick="toggleAddForm('emp')">
                    <span class="material-icons-round">person_add</span> Nuevo Empleado
                </button>
                <div id="add-emp-form" class="add-form">
                    <input type="text" id="new-emp-name" class="input-pro" placeholder="Nombre">
                    <input type="number" id="new-emp-wage" class="input-pro" placeholder="Sueldo Base ($)">
                    <button class="btn-primary-action" style="background:var(--primary);" onclick="addNewEmpleado()">Guardar Empleado</button>
                </div>
            </div>
        </div>

        <div id="screen-proveedores" class="screen">
             <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); text-align:center;">
                <div style="color:white; opacity:0.9; font-size:0.8rem; font-weight:700; margin-bottom:5px;">PAGOS PROVEEDORES</div>
                <div style="color:white; font-size:2.8rem; font-weight:800; line-height:1.1;" id="prov-day-total">$ 0</div>
            </div>
            <div class="card" style="margin-top:15px;">
                <div id="prov-list" class="clean-list"></div>
            </div>
        </div>

        <div id="screen-alertas" class="screen">
            <div class="card">
                <div class="card-header">Centro de Alertas</div>
                <div id="alerts-list"></div>
            </div>
        </div>

    </div>

    <div class="fab-container">
        <button class="fab-refresh" onclick="forceRefresh()"><span class="material-icons-round" style="font-size:24px;">sync</span></button>
    </div>

    <script>
        // === CONFIGURACIÓN ===
        const API_URL = "https://cajamercadolimpio.santamariapablodaniel.workers.dev/";
        const apiKey = ""; 

        // === ESTADO ===
        let currentDateStr = "";
        let currentMovs = [];
        let fuelMovsByVehicle = {};
        
        let chartEgresos = null;
        let chartRanking = null;

        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            const offset = today.getTimezoneOffset() * 60000;
            const localIso = new Date(today.getTime() - offset).toISOString().split('T')[0];
            
            setDate(localIso);
            fetchStatusCaja();
            fetchEmpleados();
            fetchGastosFijos();
            initSwipe();
        });

        // === FECHAS ===
        function setDate(isoDate) {
            currentDateStr = isoDate;
            const picker = document.getElementById('date-picker');
            if(picker) picker.value = isoDate;
            
            const d = new Date(isoDate + "T12:00:00");
            const today = new Date(); today.setHours(12,0,0,0);
            const diff = Math.round((d - today) / (1000 * 60 * 60 * 24));
            
            let label = d.toLocaleDateString('es-AR', {day:'numeric', month:'short'});
            if(diff === 0) label = "Hoy";
            else if(diff === -1) label = "Ayer";
            else if(diff === 1) label = "Mañana";
            
            document.getElementById('date-label').textContent = label;
            fetchDataForDate(currentDateStr);
            
            if(document.getElementById('screen-tendencias').classList.contains('active')){
                loadTrendsData();
            }
        }

        function changeDate(delta) {
            const d = new Date(currentDateStr + "T12:00:00");
            d.setDate(d.getDate() + delta);
            setDate(d.toISOString().split('T')[0]);
        }
        function onDatePick(val) { if(val) setDate(val); }

        // === DATA FETCHING ===
        async function api(fn, params = {}) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({fn, params})
                });
                return await res.json();
            } catch (e) { console.error(e); return null; }
        }

        async function fetchDataForDate(dateStr) {
            const listEl = document.getElementById('movimientos-list');
            listEl.style.opacity = '0.5';
            const fechaSegura = dateStr + "T12:00:00";
            const res = await api("getMovimientos", { fechaStr: fechaSegura });
            listEl.style.opacity = '1';
            
            if(Array.isArray(res)) {
                currentMovs = res;
            } else {
                currentMovs = [];
            }
            processData(); 
        }

        function processData() {
            let ingresos = 0, egresos = 0;
            const fuelMap = { total: 0, vehicles: {} };
            const provMap = { total: 0, list: [] };
            const alerts = [];
            fuelMovsByVehicle = {}; 

            currentMovs.forEach(m => {
                const imp = Number(m.importe) || 0;
                const cat = (m.categoria || "").toLowerCase();
                const obs = (m.observacion || "").toLowerCase();
                
                if(m.tipo === 'Ingreso') ingresos += imp; else egresos += imp;

                // COMBUSTIBLE
                if(cat.includes('combustible')) {
                    fuelMap.total += imp;
                    let veh = m.vehiculo || "Otros";
                    if (veh === "Otros" || veh === "") {
                         if(cat.includes('saveiro') || obs.includes('saveiro')) veh = "Volkswagen Saveiro";
                         else if(cat.includes('toyota') || obs.includes('toyota') || cat.includes('hiace')) veh = "Toyota Hiace";
                         else if(cat.includes('fiat') || cat.includes('uno') || obs.includes('uno')) veh = "Fiat Uno Cargo";
                    }
                    if(!fuelMap.vehicles[veh]) fuelMap.vehicles[veh] = { count: 0, total: 0 };
                    fuelMap.vehicles[veh].count++;
                    fuelMap.vehicles[veh].total += imp;

                    if (!fuelMovsByVehicle[veh]) fuelMovsByVehicle[veh] = [];
                    fuelMovsByVehicle[veh].push({ amount: imp, time: m.hora, date: m.fecha }); 
                }

                // PROVEEDORES
                if(cat.includes('proveedor')) {
                    provMap.total += imp;
                    let name = m.proveedor || obs.replace('pago a ', '').trim() || m.categoria;
                    const provMatch = obs.match(/\[Prov: (.*?)\]/i);
                    if(provMatch && provMatch[1]) name = provMatch[1];
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                    provMap.list.push({ name, amount: imp, time: m.hora });
                }

                // ALERTAS
                if(cat.includes('diferencia') || obs.includes('faltante') || obs.includes('sobrante')) {
                    if(Math.abs(imp) > 1000) alerts.push({ type: 'danger', title: 'Diferencia Caja', msg: `${m.categoria}: ${formatMoney(imp)}` });
                }
            });

            // KPIs
            const neto = ingresos - egresos;
            document.getElementById('kpi-ingreso').textContent = formatMoney(ingresos);
            document.getElementById('kpi-egreso').textContent = formatMoney(egresos);
            const netoEl = document.getElementById('kpi-neto');
            netoEl.textContent = formatMoney(neto);
            netoEl.className = `balance-amount ${neto >= 0 ? 'text-green' : 'text-red'}`;

            renderMovsList(currentMovs);
            renderFuel(fuelMap);
            renderProv(provMap);
            renderAlerts(alerts);
        }

        // === RENDERERS (CLEAN) ===
        function renderMovsList(list) {
            const container = document.getElementById('movimientos-list');
            document.getElementById('mov-count').textContent = list.length;
            if(list.length === 0) { container.innerHTML = '<div class="empty-state">Sin movimientos.</div>'; return; }
            
            let html = '<div class="clean-list">'; 
            list.forEach(m => {
                const isIng = m.tipo === 'Ingreso';
                const color = isIng ? 'text-green' : 'text-red';
                const sign = isIng ? '+' : '-';
                const icon = getIconForCategory(m.categoria);
                const subText = `${(m.hora||"").substring(0,5)} • ${m.formaPago}`;
                
                const bgIcon = isIng ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                const colorIcon = isIng ? '#34d399' : '#f87171';

                html += `
                <div class="list-row">
                    <div style="display:flex; align-items:center; overflow:hidden;">
                        <div class="row-icon" style="background:${bgIcon}; color:${colorIcon}">
                            <span class="material-icons-round">${icon}</span>
                        </div>
                        <div class="row-info">
                            <div class="row-title">${m.categoria}</div>
                            <div class="row-sub">${subText}</div>
                        </div>
                    </div>
                    <div class="row-amount ${color}">${sign} ${formatMoney(m.importe).replace('$ ','')}</div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderFuel(map) {
            document.getElementById('fuel-day-total').textContent = formatMoney(map.total);
            const container = document.getElementById('fuel-container');
            if(map.total === 0) { container.innerHTML = '<div class="empty-state">Sin gastos.</div>'; return; }
            
            let html = '';
            for (const [v, data] of Object.entries(map.vehicles)) {
                const id = v.replace(/[^a-zA-Z0-9]/g, ''); 
                html += `
                <div class="card" style="margin-bottom:10px; padding:15px; border:1px solid rgba(255,255,255,0.05);" onclick="toggleFuel('${id}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:700;"><span class="material-icons-round" style="vertical-align:middle; margin-right:5px; color:var(--warning);">local_shipping</span> ${v}</div>
                        <div style="text-align:right;">
                            <div style="font-weight:800; color:var(--warning);">${formatMoney(data.total)}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${data.count} carga(s)</div>
                        </div>
                    </div>
                    <div id="fuel-det-${id}" style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.1);">
                        ${(fuelMovsByVehicle[v]||[]).map(m => `
                            <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:5px;">
                                <span style="color:#94a3b8;">${(m.time||"").substring(0,5)} hs</span>
                                <span style="font-weight:700;">${formatMoney(m.amount)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }
        window.toggleFuel = (id) => {
            const el = document.getElementById(`fuel-det-${id}`);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        };

        function renderProv(map) {
            document.getElementById('prov-day-total').textContent = formatMoney(map.total);
            const container = document.getElementById('prov-list');
            if(map.list.length === 0) { container.innerHTML = '<div class="empty-state">Sin pagos.</div>'; return; }
            container.innerHTML = map.list.map(p => `
                <div class="list-row">
                    <div style="display:flex; align-items:center;">
                        <div class="row-icon" style="background:rgba(139, 92, 246, 0.1); color:var(--purple);"><span class="material-icons-round">inventory_2</span></div>
                        <div class="row-info"><div class="row-title">${p.name}</div><div class="row-sub">${p.time} hs</div></div>
                    </div>
                    <div class="row-amount text-red">- ${formatMoney(p.amount).replace('$ ','')}</div>
                </div>
            `).join('');
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alerts-list');
            if(alerts.length === 0) { container.innerHTML = '<div class="empty-state">✅ Todo normal.</div>'; return; }
            container.innerHTML = alerts.map(a => `
                <div style="padding:15px; border-radius:12px; margin-bottom:10px; background:rgba(239, 68, 68, 0.1); border-left:4px solid var(--danger);">
                    <div style="font-weight:700; color:var(--danger); margin-bottom:5px;">${a.title}</div>
                    <div style="color:var(--text-muted); font-size:0.9rem;">${a.msg}</div>
                </div>
            `).join('');
        }

        // === GASTOS FIJOS (LÓGICA MEJORADA) ===
        async function fetchGastosFijos() {
            const container = document.getElementById('fijos-list');
            const res = await api("getConfigGastosFijos");
            if (!res || !res.ok) return;
            
            const list = res.data || [];
            let total = 0;
            
            if(list.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay gastos fijos configurados.</div>';
            } else {
                container.innerHTML = list.map(g => {
                    total += parseInt(g.montoMensual)||0;
                    return `
                    <div class="list-row">
                        <div style="display:flex; align-items:center;">
                             <div class="row-icon" style="background:rgba(6, 182, 212, 0.1); color:var(--info);">
                                <span class="material-icons-round">calendar_today</span>
                            </div>
                            <div class="row-info">
                                <div class="row-title">${g.nombre}</div>
                                <div class="row-sub">Mensual</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span style="color:var(--text-muted); margin-right:5px;">$</span>
                            <input type="number" class="clean-input" id="fijo-${g.nombre.replace(/\s/g,'-')}" value="${g.montoMensual}">
                            <button class="mini-save-btn" onclick="saveGastoFijo('${g.nombre}')">
                                <span class="material-icons-round" style="font-size:18px;">save</span>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('total-fijos-mensual').textContent = formatMoney(total);
        }

        async function saveGastoFijo(nombre) {
             const input = document.getElementById(`fijo-${nombre.replace(/\s/g,'-')}`);
             const val = parseInt(input.value) || 0;
             const btn = input.nextElementSibling;
             
             btn.innerHTML = '<span class="spin material-icons-round" style="font-size:18px">sync</span>';
             await api("updateConfigGastoFijo", { nombre: nombre, montoMensual: val, lastUpdate: new Date().toISOString().split('T')[0] });
             btn.innerHTML = '<span class="material-icons-round" style="font-size:18px;">check</span>';
             setTimeout(() => { 
                 btn.innerHTML = '<span class="material-icons-round" style="font-size:18px;">save</span>'; 
                 fetchGastosFijos(); 
             }, 1000);
        }

        async function addNewGastoFijo() {
            const name = document.getElementById('new-fijo-name').value;
            const amount = document.getElementById('new-fijo-amount').value;
            if(!name || !amount) return;
            
            const btn = document.querySelector('#add-fijo-form button');
            const originalText = btn.innerText;
            btn.innerText = "Guardando...";
            
            await api("addConfigGastoFijo", { nombre: name, montoMensual: parseInt(amount) });
            
            document.getElementById('new-fijo-name').value = "";
            document.getElementById('new-fijo-amount').value = "";
            toggleAddForm('fijo');
            fetchGastosFijos();
            btn.innerText = originalText;
        }

        // === EMPLEADOS ===
        async function fetchEmpleados() {
             const container = document.getElementById('empleados-list');
             const res = await api("getConfigEmpleados");
             if(!res || !res.ok) return;
             
             container.innerHTML = (res.data || []).map(e => `
                <div class="list-row">
                    <div style="display:flex; align-items:center;">
                         <div class="row-icon" style="background:rgba(59, 130, 246, 0.1); color:var(--primary);">
                            <span class="material-icons-round">person</span>
                        </div>
                        <div class="row-info">
                            <div class="row-title">${e.nombre}</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:var(--text-muted); margin-right:5px;">$</span>
                        <input type="number" class="clean-input" id="wage-${e.nombre.replace(/\s/g,'-')}" value="${e.sueldoBase}">
                        <button class="mini-save-btn" onclick="saveSueldo('${e.nombre}')">
                            <span class="material-icons-round" style="font-size:18px;">save</span>
                        </button>
                    </div>
                </div>
             `).join('');
        }
        async function saveSueldo(nombre) {
            const input = document.getElementById(`wage-${nombre.replace(/\s/g,'-')}`);
            const val = parseInt(input.value) || 0;
            const btn = input.nextElementSibling;
            btn.innerHTML = '<span class="spin material-icons-round" style="font-size:18px">sync</span>';
            await api("updateConfigEmpleado", {nombre, sueldoBase: val, lastUpdate: new Date().toISOString().split('T')[0]});
            btn.innerHTML = '<span class="material-icons-round" style="font-size:18px;">check</span>';
            setTimeout(() => { btn.innerHTML = '<span class="material-icons-round" style="font-size:18px;">save</span>'; }, 1000);
        }
        async function addNewEmpleado() {
            const name = document.getElementById('new-emp-name').value;
            const wage = document.getElementById('new-emp-wage').value;
            if(!name || !wage) return;
            await api("addConfigEmpleado", {nombre: name, sueldoBase: parseInt(wage)});
            toggleAddForm('emp');
            fetchEmpleados();
        }

        // === TENDENCIAS ===
        async function loadTrendsData() {
            if(chartEgresos) return; 
            const d = new Date(currentDateStr + "T12:00:00");
            const end = currentDateStr;
            d.setDate(d.getDate() - 6);
            const start = d.toISOString().split('T')[0];
            
            const res = await api("getMovimientosRango", {startDateStr: start, endDateStr: end});
            if(res && res.ok && res.data) {
                renderTrendsCharts(res.data);
            }
        }
        function renderTrendsCharts(data) {
            const days = {};
            const cats = {};
            data.forEach(m => {
                if(m.tipo === 'Egreso') {
                    if(!days[m.fecha]) days[m.fecha] = 0;
                    days[m.fecha] += parseInt(m.importe);
                    if(!cats[m.categoria]) cats[m.categoria] = 0;
                    cats[m.categoria] += parseInt(m.importe);
                }
            });
            const ctx1 = document.getElementById('chartEgresos');
            if(ctx1) {
                chartEgresos = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: Object.keys(days).sort().map(d => d.substring(5)), 
                        datasets: [{
                            label: 'Egresos', data: Object.keys(days).sort().map(k => days[k]),
                            borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: { x: {grid:{display:false}, ticks:{color:'#94a3b8'}}, y: {grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#94a3b8'}} } }
                });
            }
            const sortedCats = Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctx2 = document.getElementById('chartRanking');
            if(ctx2) {
                chartRanking = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCats.map(x=>x[0]),
                        datasets: [{
                            data: sortedCats.map(x=>x[1]),
                            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#10b981'], borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{position:'right', labels:{color:'#94a3b8', font:{size:10}}}} }
                });
            }
        }

        // === UTILS ===
        function fetchStatusCaja() {
            api("getEstadoCaja").then(res => {
                if(res) {
                    const ef = parseInt(res.efectivo||0), ch = parseInt(res.cheques||0);
                    document.getElementById('kpi-caja-efectivo').textContent = formatMoney(ef);
                    document.getElementById('kpi-caja-cheques').textContent = formatMoney(ch);
                    document.getElementById('kpi-caja-total').textContent = formatMoney(ef+ch);
                }
            });
        }
        function showScreen(id, tab) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-'+id).classList.add('active');
            if(tab) {
                document.querySelectorAll('.tab-chip').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            }
            if(id === 'tendencias') loadTrendsData();
        }
        function toggleAddForm(type) {
            const f = document.getElementById(type === 'emp' ? 'add-emp-form' : 'add-fijo-form');
            f.classList.toggle('active');
        }
        function formatMoney(n) { return "$ " + Number(n).toLocaleString('es-AR'); }
        function getIconForCategory(c) {
            c = (c||"").toLowerCase();
            if(c.includes('combustible')) return 'local_gas_station';
            if(c.includes('proveedor')) return 'local_shipping';
            if(c.includes('sueldo')||c.includes('haberes')) return 'badge';
            return 'paid';
        }
        function forceRefresh() { 
            const i = document.querySelector('.fab-refresh span'); i.classList.add('spin');
            setDate(currentDateStr); fetchStatusCaja(); fetchGastosFijos();
            setTimeout(() => i.classList.remove('spin'), 800);
        }
        function initSwipe() {
            let startX = 0; const content = document.getElementById('main-content-area');
            content.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; }, {passive: true});
            content.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].screenX; const diff = endX - startX;
                if (Math.abs(diff) > 80) { if (diff > 0) changeDate(-1); else changeDate(1); }
            }, {passive: true});
        }
    </script>
</body>
</html>

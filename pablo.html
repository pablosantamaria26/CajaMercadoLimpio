<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dueño - Mercado Limpio</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* =========================================
           ESTILOS V6.0: NATIVE SNAP SCROLL
           ========================================= */
        :root {
            --bg-body: #000000;       
            --bg-card: #151a23;       
            --bg-header: rgba(11, 14, 20, 0.95);
            --primary: #3b82f6;       
            --success: #10b981;       
            --danger: #ef4444;       
            --warning: #f59e0b;       
            --info: #06b6d4;
            --purple: #8b5cf6;
            --text-muted: #94a3b8;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: white;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; /* Evita rebote general */
        }

        /* --- HEADER FIJO --- */
        .header-fixed {
            flex: 0 0 auto; /* No se encoge */
            height: calc(60px + var(--safe-top));
            padding-top: var(--safe-top);
            background: var(--bg-header);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 20px; padding-right: 20px;
            z-index: 100;
        }
        .header-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .btn-calendar {
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 36px; height: 36px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .date-display { font-size: 0.8rem; font-weight: 700; margin-right: 10px; color: var(--primary); }

        /* --- CONTENEDOR PRINCIPAL (LA MAGIA DEL SNAP) --- */
        .snap-container {
            flex: 1; /* Ocupa el resto de la pantalla */
            display: flex;
            overflow-x: auto; /* Scroll horizontal */
            overflow-y: hidden;
            scroll-snap-type: x mandatory; /* Esto hace que se clave en cada pantalla */
            -webkit-overflow-scrolling: touch; /* Suavidad en iOS */
            scrollbar-width: none; /* Ocultar barra scroll Firefox */
        }
        .snap-container::-webkit-scrollbar { display: none; /* Ocultar barra scroll Chrome/Safari */ }

        /* CADA PANTALLA */
        .screen {
            flex: 0 0 100%; /* Ancho completo */
            width: 100vw;
            height: 100%;
            scroll-snap-align: start; /* Punto de anclaje */
            overflow-y: auto; /* Scroll vertical interno */
            padding: 20px;
            padding-bottom: 100px; /* Espacio para el FAB */
        }

        /* --- PUNTOS INDICADORES --- */
        .dots-container {
            position: fixed; bottom: 25px; left: 25px;
            display: flex; gap: 6px; z-index: 90;
            background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px;
            backdrop-filter: blur(4px);
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: 0.3s; }
        .dot.active { background: var(--primary); width: 18px; border-radius: 10px; }

        /* --- CARDS & WIDGETS --- */
        .card {
            background: var(--bg-card); border-radius: 24px; padding: 24px;
            margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.03);
        }
        .card-header { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        /* Hero */
        .hero-card { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); text-align: center; padding: 30px 20px; }
        .balance-amount { 
            font-size: 3.5rem; font-weight: 800; letter-spacing: -2px; margin: 10px 0;
            background: -webkit-linear-gradient(90deg, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .kpi-row { display: flex; gap: 15px; margin-top: 25px; }
        .kpi-pill { flex: 1; background: rgba(255,255,255,0.03); border-radius: 16px; padding: 12px; border: 1px solid rgba(255,255,255,0.02); display:flex; flex-direction:column; align-items:center; }
        
        /* Widget Banco */
        .bank-widget {
            background: linear-gradient(135deg, #7c3aed 0%, #4c1d95 100%);
            border-radius: 20px; padding: 20px; color: white;
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; gap: 10px;
        }
        .pulse-ring {
            position: absolute; right: -20px; top: -20px; width: 100px; height: 100px; border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.1); animation: pulse 2s infinite; display: none;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }

        /* --- LISTAS Y DETALLES --- */
        .clean-list { display: flex; flex-direction: column; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .list-row:active { background: rgba(255,255,255,0.05); }
        
        /* Detalle desplegable */
        .row-detail-panel {
            display: none; background: rgba(0,0,0,0.3); margin-top: -1px; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .detail-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #cbd5e1; }

        /* Utils */
        .text-green { color:#34d399; -webkit-text-fill-color: #34d399; }
        .text-red { color:#f87171; -webkit-text-fill-color: #f87171; }
        .pm-label { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; font-weight: 700; }
        
        .fab-refresh { position: fixed; bottom: 25px; right: 25px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        .spin { animation: spin 1s infinite linear; } @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .modal-overlay.active { display: flex; }

        /* Inputs */
        .clean-input { background: transparent; border: 1px solid transparent; color: white; text-align: right; width: 100px; padding: 5px; border-radius: 8px; outline: none; font-weight: 700; }
        .clean-input:focus { background: rgba(255,255,255,0.1); border-color: var(--info); }
        .mini-save-btn { background: var(--info); color: white; border: none; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-left: 8px; }
    </style>
</head>
<body>

    <div class="header-fixed">
        <div class="header-title">
            <span class="material-icons-round" style="color:var(--primary)">analytics</span>
            <span id="header-page-title">Resumen</span>
        </div>
        <div style="display: flex; align-items: center;">
            <span class="date-display" id="date-label">Hoy</span>
            <button class="btn-calendar" onclick="toggleCalendar()">
                <span class="material-icons-round">calendar_today</span>
            </button>
        </div>
    </div>

    <div class="snap-container" id="snap-scroll">

        <div class="screen" id="screen-0">
            <div class="card hero-card">
                <div style="color:var(--text-muted); font-size:0.75rem; text-transform:uppercase; letter-spacing:2px; font-weight:700;">Resultado Operativo</div>
                <div class="balance-amount" id="kpi-neto">--</div>
                <div class="kpi-row">
                    <div class="kpi-pill">
                        <div style="font-size:1.1rem; font-weight:700;" class="text-green" id="kpi-ingreso">--</div>
                        <div class="kpi-pill-lbl">Ingresos</div>
                    </div>
                    <div class="kpi-pill">
                        <div style="font-size:1.1rem; font-weight:700;" class="text-red" id="kpi-egreso">--</div>
                        <div class="kpi-pill-lbl">Egresos</div>
                    </div>
                </div>
            </div>

            <div class="card bank-widget">
                <div class="pulse-ring" id="bank-pulse"></div>
                <div style="z-index: 1;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="pm-label" style="opacity:0.9; color:#e9d5ff;">TRANSFERENCIAS HOY</div>
                        <div id="bank-icon-status"><span class="material-icons-round spin" style="font-size:16px;">sync</span></div>
                    </div>
                    <div style="margin-top:5px;">
                        <div style="font-size:2rem; font-weight:800;" id="kpi-banco-dia">$ 0</div>
                        <div style="font-size:0.8rem; opacity:0.7;" id="bank-status-msg">Escaneando...</div>
                    </div>
                </div>
                <div style="height:1px; background:rgba(255,255,255,0.2); margin:5px 0;"></div>
                <div style="display:flex; justify-content:space-between; align-items:center; z-index: 1;">
                    <div class="pm-label" style="opacity:0.8;">ACUMULADO MES</div>
                    <div style="font-size:1.4rem; font-weight:700;" id="kpi-banco-mes">--</div>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <div class="pm-label">CAJA FÍSICA TOTAL</div>
                    <div class="pm-label text-green" id="kpi-caja-total" style="font-size:1rem;">$ 0</div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                        <div style="font-size:0.7rem; color:#94a3b8;">Efectivo</div>
                        <div style="font-weight:700;" id="kpi-caja-efectivo">--</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                        <div style="font-size:0.7rem; color:#94a3b8;">Cheques</div>
                        <div style="font-weight:700;" id="kpi-caja-cheques">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="screen-1">
             <div class="card">
                <div class="card-header">Evolución Egresos (7 Días)</div>
                <div style="height:250px; position:relative;"><canvas id="chartEgresos"></canvas></div>
             </div>
             <div class="card">
                <div class="card-header">Ranking de Gastos</div>
                <div style="height:250px; position:relative;"><canvas id="chartRanking"></canvas></div>
             </div>
        </div>

        <div class="screen" id="screen-2">
            <div class="card">
                <div class="card-header">
                    <span>Historial del Día</span>
                    <span id="mov-count" style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:0.75rem; color:white;">0</span>
                </div>
                <div id="movimientos-list"></div>
            </div>
        </div>

        <div class="screen" id="screen-3">
             <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); text-align:center;">
                <div style="opacity:0.9; font-size:0.8rem; font-weight:700;">GASTO COMBUSTIBLE (DÍA)</div>
                <div style="font-size:2.5rem; font-weight:800;" id="fuel-day-total">$ 0</div>
            </div>
            <div id="fuel-container" style="margin-top:20px;"></div>
        </div>

        <div class="screen" id="screen-4">
             <div class="card" style="background:rgba(6, 182, 212, 0.1); border:1px solid rgba(6, 182, 212, 0.3); text-align:center;">
                <div style="color:var(--info); font-size:0.8rem; font-weight:700; text-transform:uppercase;">Proyección Mensual</div>
                <div style="font-size:2.5rem; font-weight:800; color:var(--info); margin:10px 0;" id="total-fijos-mensual">--</div>
            </div>
            <div class="card">
                <div class="card-header">Detalle Gastos Fijos</div>
                <div id="fijos-list" class="clean-list"></div>
            </div>
        </div>

        <div class="screen" id="screen-5">
            <div class="card">
                <div class="card-header">Sueldos Base</div>
                <div id="empleados-list" class="clean-list"></div>
            </div>
        </div>

        <div class="screen" id="screen-6">
             <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); text-align:center;">
                <div style="opacity:0.9; font-size:0.8rem; font-weight:700;">PAGOS PROVEEDORES</div>
                <div style="font-size:2.5rem; font-weight:800;" id="prov-day-total">$ 0</div>
            </div>
            <div class="card" style="margin-top:15px;">
                <div id="prov-list" class="clean-list"></div>
            </div>
        </div>

        <div class="screen" id="screen-7">
            <div class="card">
                <div class="card-header">Centro de Alertas</div>
                <div id="alerts-list"></div>
            </div>
        </div>

    </div>

    <div class="dots-container" id="dots-container"></div>

    <button class="fab-refresh" onclick="forceRefresh()">
        <span class="material-icons-round" style="font-size:24px;">sync</span>
    </button>

    <div class="modal-overlay" id="calendar-modal" onclick="if(event.target===this) toggleCalendar()">
        <div class="modal-content">
            <h3 style="margin-top:0; color:white;">Ir a fecha</h3>
            <input type="date" id="date-picker-input" style="width:100%; padding:15px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:10px; font-size:1.1rem; margin:20px 0;">
            <button onclick="confirmDate()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:700; font-size:1rem;">Ver Datos</button>
        </div>
    </div>

    <script>
        const API_URL = "https://cajamercadolimpio.santamariapablodaniel.workers.dev/";
        
        let currentDateStr = "";
        const pageTitles = ["Resumen", "Tendencias", "Movimientos", "Combustible", "Gastos Fijos", "Empleados", "Proveedores", "Alertas"];
        let currentMovs = [];
        let fuelMovsByVehicle = {};
        
        let chartEgresos = null;
        let chartRanking = null;

        // INICIO
        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            const offset = today.getTimezoneOffset() * 60000;
            const localIso = new Date(today.getTime() - offset).toISOString().split('T')[0];
            
            setDate(localIso);
            
            // Generar puntitos
            const dotsC = document.getElementById('dots-container');
            pageTitles.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = `dot ${i===0?'active':''}`;
                dotsC.appendChild(d);
            });

            // Observer para saber en qué pantalla estamos (Scroll Snap Detection)
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if(entry.isIntersecting) {
                        const index = parseInt(entry.target.id.split('-')[1]);
                        document.getElementById('header-page-title').innerText = pageTitles[index];
                        document.querySelectorAll('.dot').forEach((d, i) => d.className = `dot ${i===index?'active':''}`);
                        
                        // Carga perezosa de gráficos
                        if(index === 1) loadTrendsData();
                    }
                });
            }, { threshold: 0.6 });

            document.querySelectorAll('.screen').forEach(s => observer.observe(s));
            
            // Cargas iniciales
            fetchStatusCaja();
            fetchBancosDia();
            fetchGastosFijos();
            fetchEmpleados();
        });

        // --- BANCO / TRANSFERENCIAS ---
        async function fetchBancosDia() {
            const diaEl = document.getElementById('kpi-banco-dia');
            const mesEl = document.getElementById('kpi-banco-mes');
            const statusEl = document.getElementById('bank-status-msg');
            const iconEl = document.getElementById('bank-icon-status');
            const pulseEl = document.getElementById('bank-pulse');

            // Animación buscando
            pulseEl.style.display = 'block';
            statusEl.innerText = "Buscando rendición...";
            iconEl.innerHTML = '<span class="material-icons-round spin">sync</span>';

            const res = await api("getResumenBancosDueño");
            
            pulseEl.style.display = 'none'; // Fin animación

            if (res && res.ok) {
                diaEl.textContent = formatMoney(res.totalDia);
                mesEl.textContent = formatMoney(res.totalMes); // ✅ ACUMULADO CONFIRMADO DESDE DIA 1

                if (res.totalDia > 0) {
                    statusEl.innerHTML = '<span style="color:#34d399; font-weight:700;">Rendición Recibida ✅</span>';
                    iconEl.innerHTML = '<span class="material-icons-round" style="color:#34d399;">check_circle</span>';
                } else {
                    statusEl.innerText = "Esperando archivo... ⏳";
                    iconEl.innerHTML = '<span class="material-icons-round" style="color:#94a3b8;">schedule</span>';
                }
            } else {
                statusEl.innerText = "Error conexión";
                iconEl.innerHTML = '<span class="material-icons-round" style="color:#ef4444;">error</span>';
            }
        }

        // --- MOVIMIENTOS Y DETALLES ---
        function renderMovs(list) {
            const c = document.getElementById('movimientos-list');
            document.getElementById('mov-count').textContent = list.length;
            
            if(list.length === 0) { c.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b; font-style:italic;">Sin movimientos</div>'; return; }
            
            c.innerHTML = list.map((m, i) => {
                const isIng = m.tipo === 'Ingreso';
                const color = isIng ? '#34d399' : '#f87171';
                const bgIcon = isIng ? 'rgba(52, 211, 153, 0.1)' : 'rgba(248, 113, 113, 0.1)';
                const icon = m.categoria.toLowerCase().includes('combustible') ? 'local_gas_station' : (isIng ? 'arrow_downward' : 'arrow_upward');
                const id = `det-${i}`;

                return `
                <div style="border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div class="list-row" onclick="toggleDetail('${id}')" style="border:none;">
                        <div style="display:flex; align-items:center;">
                            <div style="background:${bgIcon}; width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-right:15px;">
                                <span class="material-icons-round" style="color:${color}">${icon}</span>
                            </div>
                            <div>
                                <div style="font-weight:600; font-size:0.95rem;">${m.categoria}</div>
                                <div style="font-size:0.8rem; color:#64748b;">${(m.hora||"").substring(0,5)} • ${m.formaPago}</div>
                            </div>
                        </div>
                        <div style="font-weight:700; color:${color}">${isIng?'+':'-'} ${formatMoney(m.importe).replace('$ ','')}</div>
                    </div>
                    <div id="${id}" class="row-detail-panel">
                        <div class="detail-line"><span>Obs:</span> <span style="color:white; text-align:right;">${m.observacion||"-"}</span></div>
                        <div class="detail-line"><span>Usuario:</span> <span style="color:white;">${m.usuario||"Sistema"}</span></div>
                        <div class="detail-line"><span>ID:</span> <span style="font-family:monospace;">#${m.id}</span></div>
                    </div>
                </div>
                `;
            }).join('');
        }

        window.toggleDetail = (id) => {
            const el = document.getElementById(id);
            if(el.style.display === "block") el.style.display = "none";
            else el.style.display = "block";
        };

        // --- FECHAS ---
        function setDate(isoDate) {
            currentDateStr = isoDate;
            const d = new Date(isoDate + "T12:00:00");
            const today = new Date(); today.setHours(12,0,0,0);
            const diff = Math.round((d - today) / (1000 * 60 * 60 * 24));
            
            let label = d.toLocaleDateString('es-AR', {day:'numeric', month:'short'});
            if(diff === 0) label = "Hoy"; else if(diff === -1) label = "Ayer";
            
            document.getElementById('date-label').textContent = label;
            document.getElementById('date-picker-input').value = isoDate;
            fetchDataForDate(isoDate);
        }

        function toggleCalendar() {
            const m = document.getElementById('calendar-modal');
            m.classList.toggle('active');
        }
        
        function confirmDate() {
            const val = document.getElementById('date-picker-input').value;
            if(val) {
                setDate(val);
                toggleCalendar();
                fetchBancosDia(); // Re-chequear banco si cambia fecha
            }
        }

        // --- API CORE ---
        async function api(fn, params = {}) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({fn, params})
                });
                return await res.json();
            } catch (e) { return null; }
        }

        async function fetchDataForDate(dateStr) {
            const listEl = document.getElementById('movimientos-list');
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Cargando...</div>';
            
            const res = await api("getMovimientos", { fechaStr: dateStr + "T12:00:00" });
            if(Array.isArray(res)) currentMovs = res; else currentMovs = [];
            
            processData(); 
        }

        function fetchStatusCaja() {
             api("getEstadoCaja").then(res => {
                if(res) {
                    const ef = parseInt(res.efectivo||0), ch = parseInt(res.cheques||0);
                    document.getElementById('kpi-caja-efectivo').textContent = formatMoney(ef);
                    document.getElementById('kpi-caja-cheques').textContent = formatMoney(ch);
                    document.getElementById('kpi-caja-total').textContent = formatMoney(ef+ch);
                }
            });
        }

        function processData() {
            let ingresos = 0, egresos = 0;
            const fuelMap = { total: 0, vehicles: {} };
            const provMap = { total: 0, list: [] };
            const alerts = [];
            fuelMovsByVehicle = {};

            currentMovs.forEach(m => {
                const imp = Number(m.importe) || 0;
                const cat = (m.categoria || "").toLowerCase();
                const obs = (m.observacion || "").toLowerCase();
                
                if(m.tipo === 'Ingreso') ingresos += imp; else egresos += imp;

                // Combustible
                if(cat.includes('combustible')) {
                    fuelMap.total += imp;
                    let veh = m.vehiculo || "Otros";
                    if(veh==="Otros"||veh==="") {
                         if(cat.includes('saveiro')) veh="VW Saveiro";
                         else if(cat.includes('toyota')||cat.includes('hiace')) veh="Toyota Hiace";
                         else if(cat.includes('fiat')||cat.includes('uno')) veh="Fiat Uno";
                    }
                    if(!fuelMap.vehicles[veh]) fuelMap.vehicles[veh] = { count: 0, total: 0 };
                    fuelMap.vehicles[veh].count++;
                    fuelMap.vehicles[veh].total += imp;
                    if(!fuelMovsByVehicle[veh]) fuelMovsByVehicle[veh] = [];
                    fuelMovsByVehicle[veh].push({amount:imp, time:m.hora});
                }
                
                // Proveedores
                if(cat.includes('proveedor')) {
                    provMap.total += imp;
                    let name = m.proveedor || obs.replace('pago a ', '').trim() || m.categoria;
                    const provMatch = obs.match(/\[Prov: (.*?)\]/i);
                    if(provMatch && provMatch[1]) name = provMatch[1];
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                    provMap.list.push({ name, amount: imp, time: m.hora });
                }

                // Alertas
                if(cat.includes('diferencia') || obs.includes('faltante') || obs.includes('sobrante')) {
                    if(Math.abs(imp) > 1000) alerts.push({ type: 'danger', title: 'Diferencia Caja', msg: `${m.categoria}: ${formatMoney(imp)}` });
                }
            });

            // Update KPIs
            document.getElementById('kpi-ingreso').textContent = formatMoney(ingresos);
            document.getElementById('kpi-egreso').textContent = formatMoney(egresos);
            const neto = ingresos - egresos;
            const nEl = document.getElementById('kpi-neto');
            nEl.textContent = formatMoney(neto);
            nEl.className = `balance-amount ${neto>=0?'text-green':'text-red'}`;

            renderMovs(currentMovs);
            renderFuel(fuelMap);
            renderProv(provMap);
            renderAlerts(alerts);
        }

        // Renderers auxiliares
        function renderFuel(map) {
            document.getElementById('fuel-day-total').textContent = formatMoney(map.total);
            const c = document.getElementById('fuel-container');
            if(map.total===0) { c.innerHTML = '<div style="text-align:center; color:#64748b;">Sin cargas</div>'; return; }
            c.innerHTML = Object.entries(map.vehicles).map(([v, d]) => `
                <div class="card" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:700;">${v}</div>
                    <div style="text-align:right;">
                        <div style="color:var(--warning); font-weight:800;">${formatMoney(d.total)}</div>
                        <div style="font-size:0.7rem; color:#64748b;">${d.count} carga(s)</div>
                    </div>
                </div>
            `).join('');
        }

        function renderProv(map) {
            document.getElementById('prov-day-total').textContent = formatMoney(map.total);
            const c = document.getElementById('prov-list');
            if(map.list.length === 0) { c.innerHTML = '<div style="text-align:center; color:#64748b;">Sin pagos</div>'; return; }
            c.innerHTML = map.list.map(p => `
                <div class="list-row">
                    <div style="display:flex; align-items:center;">
                        <div style="background:rgba(139, 92, 246, 0.1); width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-right:15px;">
                            <span class="material-icons-round" style="color:var(--purple)">inventory_2</span>
                        </div>
                        <div><div style="font-weight:600;">${p.name}</div><div style="font-size:0.8rem; color:#64748b;">${p.time} hs</div></div>
                    </div>
                    <div class="text-red">- ${formatMoney(p.amount).replace('$ ','')}</div>
                </div>
            `).join('');
        }

        function renderAlerts(alerts) {
            const c = document.getElementById('alerts-list');
            if(alerts.length === 0) { c.innerHTML = '<div style="text-align:center; color:#64748b;">✅ Todo normal</div>'; return; }
            c.innerHTML = alerts.map(a => `<div style="padding:15px; border-radius:12px; margin-bottom:10px; background:rgba(239, 68, 68, 0.1); border-left:4px solid var(--danger);"><div style="font-weight:700; color:var(--danger);">${a.title}</div><div style="color:#94a3b8; font-size:0.9rem;">${a.msg}</div></div>`).join('');
        }

        // Otros
        async function fetchGastosFijos() {
            const container = document.getElementById('fijos-list');
            const res = await api("getConfigGastosFijos");
            if (!res || !res.ok) return;
            const list = res.data || [];
            let total = 0;
            if(list.length === 0) container.innerHTML = '<div style="text-align:center;">Sin gastos</div>';
            else {
                container.innerHTML = list.map(g => {
                    total += parseInt(g.montoMensual)||0;
                    return `<div class="list-row"><div><div>${g.nombre}</div><div style="font-size:0.8rem; color:#64748b;">Mensual</div></div><div style="display:flex; align-items:center;"><span style="margin-right:5px;">$</span><input type="number" class="clean-input" onchange="saveGastoFijo('${g.nombre}', this.value)" value="${g.montoMensual}"></div></div>`;
                }).join('');
            }
            document.getElementById('total-fijos-mensual').textContent = formatMoney(total);
        }
        async function saveGastoFijo(nombre, val) { await api("updateConfigGastoFijo", { nombre, montoMensual: val, lastUpdate: new Date().toISOString().split('T')[0] }); fetchGastosFijos(); }

        async function fetchEmpleados() {
             const c = document.getElementById('empleados-list');
             const res = await api("getConfigEmpleados");
             if(!res || !res.ok) return;
             c.innerHTML = (res.data || []).map(e => `<div class="list-row"><div>${e.nombre}</div><div style="display:flex; align-items:center;"><span style="margin-right:5px;">$</span><input type="number" class="clean-input" onchange="saveSueldo('${e.nombre}', this.value)" value="${e.sueldoBase}"></div></div>`).join('');
        }
        async function saveSueldo(nombre, val) { await api("updateConfigEmpleado", {nombre, sueldoBase: val, lastUpdate: new Date().toISOString().split('T')[0]}); }

        async function loadTrendsData() {
            if(chartEgresos) return; 
            const d = new Date(currentDateStr + "T12:00:00");
            const end = currentDateStr;
            d.setDate(d.getDate() - 6);
            const start = d.toISOString().split('T')[0];
            const res = await api("getMovimientosRango", {startDateStr: start, endDateStr: end});
            if(res && res.ok && res.data) renderTrendsCharts(res.data);
        }

        function renderTrendsCharts(data) {
            const days = {}; const cats = {};
            data.forEach(m => {
                if(m.tipo === 'Egreso') {
                    if(!days[m.fecha]) days[m.fecha] = 0; days[m.fecha] += parseInt(m.importe);
                    if(!cats[m.categoria]) cats[m.categoria] = 0; cats[m.categoria] += parseInt(m.importe);
                }
            });
            const ctx1 = document.getElementById('chartEgresos');
            if(ctx1) chartEgresos = new Chart(ctx1, { type: 'line', data: { labels: Object.keys(days).sort().map(d => d.substring(5)), datasets: [{ label: 'Egresos', data: Object.keys(days).sort().map(k => days[k]), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: { x: {grid:{display:false}, ticks:{color:'#94a3b8'}}, y: {grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#94a3b8'}} } } });
            const sortedCats = Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctx2 = document.getElementById('chartRanking');
            if(ctx2) chartRanking = new Chart(ctx2, { type: 'doughnut', data: { labels: sortedCats.map(x=>x[0]), datasets: [{ data: sortedCats.map(x=>x[1]), backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#10b981'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{position:'right', labels:{color:'#94a3b8', font:{size:10}}}} } });
        }

        function forceRefresh() { 
            const i = document.querySelector('.fab-refresh span'); i.classList.add('spin');
            setDate(currentDateStr); fetchStatusCaja(); fetchBancosDia();
            setTimeout(() => i.classList.remove('spin'), 800);
        }

        function formatMoney(n) { return "$ " + Number(n).toLocaleString('es-AR'); }

    </script>
</body>
</html>

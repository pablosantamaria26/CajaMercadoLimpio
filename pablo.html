<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Mercado Limpio - Due√±o</title>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILOS V1.1: DARK EXECUTIVE & RESPONSIVE
           ========================================= */
        :root {
            --bg-dark: #1F2937; 
            --card-bg: #374151; 
            --text-light: #F9FAFB;
            --text-muted: #D1D5DB;
            --primary-accent: #3B82F6; 
            --success: #10B981; 
            --warning: #F59E0B; 
            --danger: #EF4444; 
            --alert-critical: #991B1B;
            --alert-medium: #FCD34D;
            --kpi-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            padding-bottom: 90px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .app-header { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(8px); 
            position: sticky; 
            top: 0; 
            z-index: 50; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            gap: 10px; /* NEW: Added gap */
        }
        .app-title { font-size: 1.3rem; font-weight: 900; color: var(--primary-accent); display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .header-actions { display: flex; align-items: center; gap: 15px; }

        .date-display { font-size: 0.9rem; font-weight: 400; color: var(--text-muted); flex-shrink: 0; }
        .notification-icon { position: relative; cursor: pointer; color: var(--text-light); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 700; line-height: 1; }
        
        /* NEW: KPI box in header for quick glance (Ingreso Neto) */
        .header-net-kpi {
            font-size: 0.9rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 8px;
            transition: all 0.3s;
            flex-grow: 1;
            text-align: center;
        }


        /* --- CARDS & LAYOUT --- */
        .content-container { padding: 15px; }
        .card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: var(--kpi-shadow); 
            transition: padding 0.2s; /* Added for responsive transition */
        }
        .section-title { 
            font-size: 1.1rem; 
            color: var(--text-light); 
            font-weight: 700; 
            margin-bottom: 15px; 
            border-bottom: 2px solid rgba(255,255,255,0.05);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- KPI GRIDS --- */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .kpi-item {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .kpi-label { font-size: 0.8rem; font-weight: 400; color: var(--text-muted); margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 900; line-height: 1.2; transition: font-size 0.2s; } /* Added transition for responsive font */
        
        .kpi-ingreso { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .kpi-egreso { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .kpi-neto-pos { background: rgba(59, 130, 246, 0.15); color: var(--primary-accent); }
        .kpi-neto-neg { background: rgba(239, 68, 68, 0.3); color: var(--danger); }
        
        /* --- NARRATIVA INTELIGENTE --- */
        .narrativa-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-accent);
            line-height: 1.5;
            font-size: 0.95rem;
            transition: line-height 0.2s; /* Added for responsive text */
        }
        .narrativa-title { font-weight: 700; color: var(--primary-accent); margin-bottom: 5px; }
        .highlight-green { color: var(--success); font-weight: 700; }
        .highlight-red { color: var(--danger); font-weight: 700; }

        /* --- METRICA RIESGO (FLAG) --- */
        .risk-flag-container { 
            padding: 20px; 
            border-radius: 16px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .risk-flag-container h3 { margin: 0 0 5px; font-size: 1.1rem; }
        .risk-flag-container .ratio { font-size: 2.5rem; font-weight: 900; margin-bottom: 5px; }
        
        .risk-green { background: rgba(16, 185, 129, 0.2); border: 2px solid var(--success); color: var(--success); }
        .risk-yellow { background: rgba(245, 158, 11, 0.2); border: 2px solid var(--warning); color: var(--warning); }
        .risk-red { background: rgba(239, 68, 68, 0.2); border: 2px solid var(--danger); color: var(--danger); }

        /* --- GRAFICOS (MOCK) --- */
        .chart-mock {
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        /* --- ANALISIS R√ÅPIDO (TABS) --- */
        .analysis-tabs { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 10px; margin-bottom: 15px; }
        .tab-btn {
            background: var(--card-bg);
            color: var(--text-muted);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn.active {
            background: var(--primary-accent);
            color: var(--text-light);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .analysis-content { animation: fadeIn 0.4s; }

        /* --- SEGURIDAD / ALERTS --- */
        .alert-list { list-style: none; padding: 0; }
        .alert-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            opacity: 1; /* For "Mark as read" effect */
            transition: opacity 0.3s;
        }
        .alert-item.critical { background: var(--alert-critical); border-left: 5px solid var(--danger); }
        .alert-item.medium { background: rgba(245, 158, 11, 0.2); border-left: 5px solid var(--warning); color: var(--warning); }
        .alert-item.info { background: rgba(59, 130, 246, 0.1); border-left: 5px solid var(--primary-accent); color: var(--text-muted); }

        /* --- BUSCADOR --- */
        #global-search { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 2px solid var(--card-bg); 
            background: var(--bg-dark); 
            color: var(--text-light); 
            font-size: 1rem; 
            margin-bottom: 15px;
        }

        /* --- NAV --- */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(31, 41, 55, 0.95); 
            backdrop-filter: blur(8px); 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3); 
            z-index: 100; 
        }
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: var(--text-muted); 
            text-decoration: none; 
            font-size: 0.75rem; 
            font-weight: 700; 
            transition: color 0.2s, background 0.2s; 
            padding: 8px 10px;
            border-radius: 8px;
        }
        .nav-item.active { 
            color: var(--primary-accent); 
            background: rgba(59, 130, 246, 0.1); 
        }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        /* --- UTILS --- */
        .screen { display: none; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- AUXILIAR SIMULACION (PARA LA HISTORIA) --- */
        .history-item { 
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-accent);
        }
        .history-item-title { font-weight: 700; margin-bottom: 5px; }

        /* =========================================
           RESPONSIVE AJUSTES (iPhone 14)
           ========================================= */
        @media (max-width: 400px) {
            .app-header { padding: 10px 15px; }
            .app-title { font-size: 1.1rem; }
            .date-display { display: none; } /* Sacamos la fecha para ahorrar espacio */
            .header-net-kpi { font-size: 0.8rem; padding: 2px 6px; } /* (6.2) Smaller header KPI */
            
            .kpi-value { font-size: 1.5rem; } /* (6.1) KPI font slightly smaller */
            .content-container { padding: 10px; } /* (6.3) Reduced card padding */
            .card { padding: 15px; } /* (6.3) Reduced card padding */
            .narrativa-box { line-height: 1.4; font-size: 0.9rem; } /* (6.5) Adjusted narrative line height */
            .nav-item { padding: 8px 5px; } /* (6.4) Slightly adjusted nav padding */
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="app-header">
        <div class="app-title"><span class="material-icons-round">analytics</span> Due√±o</div>
        <div class="header-net-kpi" id="header-net-kpi">--</div>
        <div class="header-actions">
            <!-- La fecha se oculta en mobile por CSS para ahorrar espacio -->
            <div class="date-display" id="current-date">Cargando...</div>
            <div class="notification-icon" onclick="showScreen('seguridad', document.querySelector('.nav-item[data-screen=\'seguridad\']'))">
                <span class="material-icons-round">notifications</span>
                <span class="badge" id="alert-badge">0</span>
            </div>
            <span class="material-icons-round" style="cursor:pointer;" onclick="fetchDashboardData()">refresh</span>
        </div>
    </header>

    <div class="content-container">

        <!-- 1. DASHBOARD DIARIO INTELIGENTE (INICIO) -->
        <div id="screen-inicio" class="screen active">
            
            <div class="risk-flag-container" id="risk-flag">
                <h3 id="risk-title">Calculando M√©trica...</h3>
                <div class="ratio" id="risk-ratio">--%</div>
                <p id="risk-message" style="font-size:0.9rem; margin: 0;"></p>
            </div>

            <div class="card">
                <div class="section-title"><span class="material-icons-round">insights</span> Pulso de Hoy</div>
                <div class="kpi-grid">
                    <div class="kpi-item kpi-ingreso">
                        <div class="kpi-label">Ingreso Total</div>
                        <div class="kpi-value" id="kpi-ingreso">--</div>
                    </div>
                    <div class="kpi-item kpi-egreso">
                        <div class="kpi-label">Egreso Total</div>
                        <div class="kpi-value" id="kpi-egreso">--</div>
                    </div>
                    <div class="kpi-item kpi-neto-pos" id="kpi-neto-box">
                        <div class="kpi-label">Resultado Neto</div>
                        <div class="kpi-value" id="kpi-neto">--</div>
                    </div>
                    <div class="kpi-item" style="background:rgba(255,255,255,0.05);">
                        <div class="kpi-label">Proyecci√≥n Mensual</div>
                        <div class="kpi-value" style="color:var(--text-light); font-size:1.5rem;" id="kpi-proyeccion">--</div>
                    </div>
                </div>

                <!-- NARRATIVA INTELIGENTE -->
                <div class="narrativa-box">
                    <div class="narrativa-title">An√°lisis R√°pido</div>
                    <div id="narrativa-diaria">Cargando...</div>
                </div>
            </div>

            <div class="card">
                <div class="section-title"><span class="material-icons-round">pie_chart</span> Ranking de Gastos (Hoy)</div>
                <div class="chart-mock" id="gasto-ranking">
                     
                </div>
                <ul id="ranking-list" style="list-style:none; padding:0; font-size:0.9rem;">
                    <!-- Se rellena con JS -->
                </ul>
            </div>
            
            <div class="card">
                <div class="section-title"><span class="material-icons-round">bolt</span> D√≠a Cr√≠tico (Resumen)</div>
                <div id="dia-critico-resumen">
                    <!-- M√≥dulo D√≠a Cr√≠tico -->
                    <p style="color:var(--text-muted);">Cargando √≠tems clave:</p>
                    <ul id="critical-items" style="list-style:none; padding:0;">
                        <!-- Se rellena con JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. DIAS ANTERIORES + VISTA DETALLADA -->
        <div id="screen-dias" class="screen">
            <div class="card">
                <div class="section-title"><span class="material-icons-round">calendar_today</span> Selecci√≥n de Fecha</div>
                <input type="date" id="date-selector" class="form-control" onchange="loadDayDetail(this.value)" style="width:100%; margin-bottom:15px; padding:10px;">
                <div class="section-title" id="day-detail-title">Detalle del D√≠a Seleccionado</div>
                <div class="chart-mock" style="height:200px; margin-bottom:15px;">
                    
                </div>
                <div id="day-detail-content">
                    <p style="color:var(--text-muted);">Selecciona una fecha para ver el detalle de movimientos, rendiciones y ajustes.</p>
                </div>
            </div>
        </div>

        <!-- 3. AN√ÅLISIS (Combustible, Sueldos, Proveedores) -->
        <div id="screen-analisis" class="screen">
            <div class="section-title"><span class="material-icons-round">data_usage</span> An√°lisis por Rubro</div>

            <div class="analysis-tabs">
                <button class="tab-btn active" data-tab="combustible" onclick="switchAnalysisTab(this)">üî• Combustible</button>
                <button class="tab-btn" data-tab="empleados" onclick="switchAnalysisTab(this)">üë• Empleados</button>
                <button class="tab-btn" data-tab="proveedores" onclick="switchAnalysisTab(this)">üöö Proveedores</button>
            </div>

            <div class="analysis-content active" id="tab-combustible">
                <div class="card">
                    <div class="section-title"><span class="material-icons-round">local_gas_station</span> Informe Combustible</div>
                    
                    <!-- (3.1) Selector de veh√≠culo -->
                    <div class="analysis-tabs" id="vehicle-tabs">
                        <button class="tab-btn active" data-vehicle="Volkswagen Saveiro" onclick="loadFuelDetails(this)">Saveiro üöö</button>
                        <button class="tab-btn" data-vehicle="Toyota Hiace" onclick="loadFuelDetails(this)">Toyota üöê</button>
                        <button class="tab-btn" data-vehicle="Fiat 1 Cargo" onclick="loadFuelDetails(this)">Uno Cargo üõª</button>
                    </div>

                    <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="kpi-item" style="background:rgba(255,255,255,0.05);">
                            <div class="kpi-label">Total Mensual</div>
                            <div class="kpi-value" id="fuel-monthly">--</div>
                        </div>
                        <div class="kpi-item" style="background:rgba(255,255,255,0.05);">
                            <div class="kpi-label">Costo Promedio</div>
                            <div class="kpi-value" id="fuel-avg-cost">--</div>
                        </div>
                        <div class="kpi-item" id="fuel-alert-box">
                            <div class="kpi-label">Cargas Semanales</div>
                            <div class="kpi-value" id="fuel-weekly-count">--</div>
                        </div>
                    </div>
                    <div class="chart-mock" style="margin-top:15px;">
                        
                    </div>
                     <!-- (3.2) Lista de cargas reales -->
                    <div style="margin-top:20px;">
                        <h4 style="margin-bottom:10px; color:var(--primary-accent);">Cargas Recientes (<span id="fuel-vehicle-title">Saveiro</span>)</h4>
                        <ul id="fuel-load-list" style="list-style:none; padding:0; font-size:0.9rem;">
                            <li style="color:var(--text-muted);">Cargando detalles...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="analysis-content" id="tab-empleados" style="display:none;">
                <div class="card">
                    <div class="section-title"><span class="material-icons-round">payments</span> Sueldos y Adelantos</div>
                    <p>Adelantos realizados este mes:</p>
                    <ul id="adelantos-list" style="list-style:disc; padding-left:20px; font-size:0.9rem; color:var(--text-muted);">
                        <li>Laura: $40.000</li>
                        <li>Nico: $10.000</li>
                    </ul>
                    <div class="chart-mock" style="height:120px; margin-top:15px;">
                         
                    </div>
                </div>
            </div>

            <div class="analysis-content" id="tab-proveedores" style="display:none;">
                <div class="card">
                    <div class="section-title"><span class="material-icons-round">inventory_2</span> Ranking de Proveedores</div>
                    <p>Top 3 gastos (√öltimas 4 semanas):</p>
                    <ol id="proveedor-ranking" style="padding-left:20px; font-size:0.9rem;">
                        <li>Romyl: $1.2M <span class="highlight-red">(-5% vs Sem. Ant.)</span></li>
                        <li>Distribuidora: $850K <span class="highlight-green">(+12% vs Sem. Ant.)</span></li>
                        <li>Proveedor X: $320K</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- 4. SEGURIDAD / ANTI-FRAUDE -->
        <div id="screen-seguridad" class="screen">
            <div class="section-title"><span class="material-icons-round">security</span> Panel Anti-Fraude (La Joya)</div>
            <div class="card">
                <h3 style="color:var(--danger); margin-top:0;">üî¥ ALERTAS CR√çTICAS</h3>
                <ul class="alert-list" id="critical-alerts">
                    <li class="alert-item critical">
                        <span class="material-icons-round">warning</span> 
                        Diferencia elevada de $32.000 en el √∫ltimo Arqueo.
                    </li>
                    <li class="alert-item critical">
                        <span class="material-icons-round">visibility_off</span> 
                        Movimiento libre registrado 4 mins despu√©s del Arqueo.
                    </li>
                </ul>

                <h3 style="color:var(--warning);">üü° RIESGO MODERADO</h3>
                <ul class="alert-list" id="medium-alerts">
                    <li class="alert-item medium">
                        <span class="material-icons-round">info</span> 
                        Se han registrado 3 Arqueos con diferencias hoy.
                    </li>
                    <li class="alert-item medium">
                        <span class="material-icons-round">edit</span> 
                        Laura edit√≥ el conteo de billetes 12 veces antes de Rendir.
                    </li>
                </ul>

                <h3 style="color:var(--primary-accent);">üü¢ INFORMACI√ìN</h3>
                <ul class="alert-list" id="info-alerts">
                    <li class="alert-item info">
                        <span class="material-icons-round">lock</span> 
                        Sistema estable. Nada sospechoso en las √∫ltimas 48hs.
                    </li>
                </ul>
            </div>
        </div>

        <!-- 5. BUSCADOR GLOBAL -->
        <div id="screen-buscador" class="screen">
            <div class="section-title"><span class="material-icons-round">travel_explore</span> Buscador Global con IA</div>
            <input type="text" id="global-search" placeholder="Ej: combustible toyota, adelanto laura, ajuste raro...">
            <button class="tab-btn active" onclick="performSearch()" style="width:100%;">BUSCAR</button>
            <div class="card" style="margin-top:15px;">
                <div class="section-title">Resultados con Narrativa</div>
                <div id="search-results">
                    <p style="color:var(--text-muted);">Escribe tu consulta arriba para buscar en todos los movimientos, rendiciones y alertas.</p>
                </div>
            </div>
        </div>

        <!-- 6. AUDITOR√çAS SEMANALES -->
        <div id="screen-auditorias" class="screen">
            <div class="section-title"><span class="material-icons-round">checklist</span> Historial de Auditor√≠as Semanales</div>
            <div class="card">
                <h3 style="color:var(--text-light); margin-top:0;">Auditor√≠a de la semana (Lunes 25/11 - Hoy)</h3>
                <ul id="auditoria-current" style="list-style:none; padding:0; font-size:0.9rem;">
                    <li style="margin-bottom:5px;">Ingresos: <span class="highlight-green">$ 4.5M</span></li>
                    <li style="margin-bottom:5px;">Egresos: <span class="highlight-red">$ 2.2M</span></li>
                    <li style="margin-bottom:5px;">Riesgo (Gastos/Ingresos): <span class="highlight-green">48.9%</span></li>
                    <li style="margin-bottom:5px; font-weight:700;">Movimiento Libre: <span class="highlight-red">$ 120.000</span> (Revisar)</li>
                </ul>
                
                <div style="margin-top:20px;">
                    <h3 style="color:var(--text-muted);">Historial de las 10 √∫ltimas</h3>
                    <div id="auditoria-historial">
                        <div class="history-item">
                            <div class="history-item-title">Semana 18 Nov - 22 Nov</div>
                            <span class="highlight-green">Riesgo: 42% (OK)</span>
                        </div>
                        <div class="history-item">
                            <div class="history-item-title">Semana 11 Nov - 15 Nov</div>
                            <span class="highlight-yellow">Riesgo: 65% (Precauci√≥n)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- NAV -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-screen="inicio" onclick="showScreen('inicio', this)">
            <span class="material-icons-round nav-icon">dashboard</span> <span>Inicio</span>
        </a>
        <a href="#" class="nav-item" data-screen="dias" onclick="showScreen('dias', this)">
            <span class="material-icons-round nav-icon">event_note</span> <span>D√≠as</span>
        </a>
        <a href="#" class="nav-item" data-screen="analisis" onclick="showScreen('analisis', this)">
            <span class="material-icons-round nav-icon">bar_chart</span> <span>An√°lisis</span>
        </a>
        <a href="#" class="nav-item" data-screen="seguridad" onclick="showScreen('seguridad', this)">
            <span class="material-icons-round nav-icon">lock</span> <span>Seguridad</span>
        </a>
        <a href="#" class="nav-item" data-screen="buscador" onclick="showScreen('buscador', this)">
            <span class="material-icons-round nav-icon">search</span> <span>Buscar</span>
        </a>
        <a href="#" class="nav-item" data-screen="auditorias" onclick="showScreen('auditorias', this)">
            <span class="material-icons-round nav-icon">history_toggle_off</span> <span>Auditor√≠as</span>
        </a>
    </nav>

    <script>
        // La URL de tu API del backend de Apps Script (es la misma)
        const API_URL = "https://cajamercadolimpio.santamariapablodaniel.workers.dev/";
        const USUARIO_APP = "Pablo (Due√±o)";

        document.addEventListener("DOMContentLoaded", () => {
            initApp();
        });

        function initApp() {
            setInitialDate();
            fetchDashboardData();
            loadAlertsBadge();
        }
        
        // --- UTILS ---
        function setInitialDate() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const todayFmt = `${dd}/${mm}/${yyyy}`;
            document.getElementById('current-date').textContent = todayFmt;
            document.getElementById('date-selector').value = `${yyyy}-${mm}-${dd}`;
        }
        
        // (1.1) Actualizar saldo y datos al cambiar de pantalla
        window.showScreen = (id, el) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            // Refresh data on screen change
            fetchDashboardData(); 
            
            // Recargar datos espec√≠ficos si se cambia a An√°lisis/Seguridad
            if (id === 'analisis') {
                switchAnalysisTab(document.querySelector('.tab-btn[data-tab="combustible"]') || document.querySelector('.tab-btn[data-tab]')); 
            }
            if (id === 'seguridad') {
                loadSecurityPanel();
            }
        };

        // --- API & DATA FETCHING ---
        async function api(fn, params = {}) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ fn, params })
                });
                return await res.json();
            } catch (e) {
                console.error("Error en la llamada a la API:", e);
                return null;
            }
        }
        
        async function loadAlertsBadge() {
            // MOCK data to ensure visual representation
            const res = [
                { id: '1', severidad: 'ALTA', titulo: 'Fraude', mensaje: 'Diff $32k', fecha: new Date().toISOString() },
                { id: '2', severidad: 'MEDIA', titulo: 'Ediciones', mensaje: '12 edits', fecha: new Date().toISOString() },
            ];
            const count = (res && res.filter(a => a.severidad === 'ALTA').length) || 0; // Solo ALTA en el badge
            document.getElementById('alert-badge').textContent = count;
            document.getElementById('alert-badge').style.display = count > 0 ? 'block' : 'none';
        }

        // (1.3) Colorear el saldo en el header
        function updateHeaderKPI(neto) {
            const kpiEl = document.getElementById('header-net-kpi');
            const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');

            kpiEl.textContent = formatCurrency(neto);
            kpiEl.style.color = 'white'; 

            if (neto > 100000) {
                kpiEl.style.backgroundColor = 'var(--success)';
            } else if (neto >= 0) {
                kpiEl.style.backgroundColor = 'var(--warning)';
                kpiEl.style.color = 'var(--bg-dark)'; // Dark text on yellow
            } else {
                kpiEl.style.backgroundColor = 'var(--danger)';
            }
        }

        async function fetchDashboardData() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            // (2.1) Usando solo la fecha, la API ya lo maneja
            const movements = await api("getMovimientos", { fechaStr: todayStr });

            if (!movements || movements.error) {
                console.error("No se pudieron cargar los movimientos diarios.");
                // Usar valores de fallback
                const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');
                document.getElementById('kpi-ingreso').textContent = formatCurrency(0);
                document.getElementById('kpi-egreso').textContent = formatCurrency(0);
                document.getElementById('kpi-neto').textContent = formatCurrency(0);
                document.getElementById('narrativa-diaria').innerHTML = '‚ùå Error al cargar datos. Revisa la API.';
                updateHeaderKPI(0);
                return;
            }

            // --- 1. C√ÅLCULO DE KPIs REAL ---
            let ingresos = 0;
            let egresos = 0;
            let totalEgreso = 0;
            const gastosPorCategoria = {};
            const MOVIMIENTOS_CRITICOS = [];
            
            movements.forEach(m => {
                const importe = m.importe;
                if (m.tipo === 'Ingreso') {
                    ingresos += importe;
                } else {
                    egresos += importe;
                    totalEgreso += importe;
                    
                    const cat = m.categoria.split(" ")[0]; // Simplificar categor√≠a para el ranking
                    gastosPorCategoria[cat] = (gastosPorCategoria[cat] || 0) + importe;
                }
                
                // M√ìDULO D√çA CR√çTICO - Identificaci√≥n de eventos clave (2.2, 2.3)
                // Se consideran rendiciones, ajustes, combustible, y cualquier gasto > $50k (valor arbitrario para "fuerte")
                if (m.categoria.includes('Rendici√≥n') || m.categoria.includes('Ajuste') || m.categoria.includes('Combustible') || importe > 50000) {
                    MOVIMIENTOS_CRITICOS.push({
                        type: m.categoria,
                        amount: m.importe,
                        time: m.hora,
                        obs: m.observacion
                    });
                }
            });

            const neto = ingresos - egresos;
            const riesgo = ingresos > 0 ? (egresos / ingresos) * 100 : 100;

            // --- 2. DISPLAY DE KPIS ---
            const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');
            
            document.getElementById('kpi-ingreso').textContent = formatCurrency(ingresos);
            document.getElementById('kpi-egreso').textContent = formatCurrency(egresos);
            document.getElementById('kpi-neto').textContent = formatCurrency(neto);
            
            const netoBox = document.getElementById('kpi-neto-box');
            netoBox.className = 'kpi-item ' + (neto >= 0 ? 'kpi-neto-pos' : 'kpi-neto-neg');
            
            updateHeaderKPI(neto); // (1.3) Actualiza el header

            // --- 3. METRICA DE RIESGO ---
            // L√≥gica de bandera (Verde, Amarillo, Rojo)
            const flagContainer = document.getElementById('risk-flag');
            flagContainer.className = 'risk-flag-container';
            let flagMsg, flagTitle;

            if (riesgo <= 55) {
                flagContainer.classList.add('risk-green');
                flagTitle = 'üü¢ BANDERA VERDE';
                flagMsg = 'Gastos bajo control. La rentabilidad de hoy es excelente.';
            } else if (riesgo <= 75) {
                flagContainer.classList.add('risk-yellow');
                flagTitle = 'üü° BANDERA AMARILLA';
                flagMsg = 'Precauci√≥n: Gastos en ascenso. Monitorea los egresos de la tarde.';
            } else {
                flagContainer.classList.add('risk-red');
                flagTitle = 'üî¥ BANDERA ROJA';
                flagMsg = '¬°Alerta! Los egresos superan o igualan el 75% de tus ingresos.';
            }

            document.getElementById('risk-title').textContent = flagTitle;
            document.getElementById('risk-ratio').textContent = `${riesgo.toFixed(1)}%`;
            document.getElementById('risk-message').textContent = flagMsg;
            
            // --- 4. PROYECCI√ìN MENSUAL ---
            const daysInMonth = 30; // Simplificaci√≥n
            const projNeto = (neto * daysInMonth);
            document.getElementById('kpi-proyeccion').textContent = formatCurrency(projNeto);
            document.getElementById('kpi-proyeccion').style.color = projNeto >= 0 ? 'var(--success)' : 'var(--danger)';

            // --- 5. NARRATIVA INTELIGENTE ---
            const sortedGastos = Object.entries(gastosPorCategoria)
                .sort(([, a], [, b]) => b - a);
            
            let narrativa = '';
            if (egresos === 0) {
                narrativa += '¬°Excelente! Hoy no hay egresos, solo ingresos. ';
            } else {
                const topGasto = sortedGastos[0];
                const topGastoPercent = (topGasto[1] / totalEgreso) * 100;
                
                narrativa += `Hoy est√°s gastando un <span class="${neto >= 0 ? 'highlight-green' : 'highlight-red'}">${riesgo.toFixed(1)}%</span> de lo que entra. `;
                narrativa += `<br><br>El rubro de **${topGasto[0]}** representa el <span class="highlight-red">${topGastoPercent.toFixed(1)}%</span> del egreso del d√≠a.`;
            }
            // Simular un chequeo de fraude basado en el backend
            const fraudAlert = (await api("getNotificacionesCaja", { soloActivas: true })).find(a => a.severidad === 'ALTA');
            if (fraudAlert) {
                narrativa += `<br><br>üö® **ALERTA DE SEGURIDAD**: Se detect√≥ un patr√≥n de ${fraudAlert.titulo} (${fraudAlert.mensaje}). Revisa el panel de Seguridad.`;
            }
            
            document.getElementById('narrativa-diaria').innerHTML = narrativa;
            
            // --- 6. RANKING DE GASTOS ---
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            sortedGastos.slice(0, 4).forEach(([cat, amount]) => {
                const percent = (amount / totalEgreso) * 100;
                rankingList.innerHTML += `
                    <li style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>${cat}</span>
                        <span>${percent.toFixed(1)}% (${formatCurrency(amount)})</span>
                    </li>
                `;
            });

            // --- 7. D√çA CR√çTICO (2.3) - Conexi√≥n Real a Movimientos clave ---
            const criticalList = document.getElementById('critical-items');
            criticalList.innerHTML = '';
            
            const rendicion = movements.find(m => m.categoria.includes('Rendici√≥n'));
            const arqueoAjuste = movements.find(m => m.categoria.includes('Ajuste Arqueo'));
            
            if (rendicion) {
                const rendDiff = rendicion.observacion.includes("Sobrante") || rendicion.observacion.includes("Faltante") ? '‚ö†Ô∏è Diferencia' : '‚úÖ Exacta';
                criticalList.innerHTML += `
                    <li style="margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:5px;">
                        <span class="material-icons-round" style="font-size:1rem; vertical-align:middle; color:var(--success);">verified</span>
                        <b>Rendici√≥n detectada:</b> a las ${rendicion.hora}. Resultado: ${rendDiff}.
                    </li>
                `;
            }

            if (arqueoAjuste) {
                const diffType = arqueoAjuste.tipo === 'Ingreso' ? 'Sobrante' : 'Faltante';
                 criticalList.innerHTML += `
                    <li style="margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:5px;">
                        <span class="material-icons-round" style="font-size:1rem; vertical-align:middle; color:var(--danger);">error</span>
                        <b>Ajuste Arqueo:</b> ${diffType} de ${formatCurrency(arqueoAjuste.importe)}.
                    </li>
                `;
            }
            
            MOVIMIENTOS_CRITICOS.filter(item => !(item.type.includes('Rendici√≥n') || item.type.includes('Ajuste'))).forEach(item => {
                 criticalList.innerHTML += `
                    <li style="margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:5px;">
                        <span class="material-icons-round" style="font-size:1rem; vertical-align:middle; color:var(--warning);">check_circle</span>
                        <b>${item.type.includes('Combustible') ? 'Combustible' : 'Gasto Fuerte'}:</b> ${formatCurrency(item.amount)} a las ${item.time}.
                    </li>
                `;
            });
            if (criticalList.children.length === 0) {
                 criticalList.innerHTML = '<li style="color:var(--success);">D√≠a sin eventos cr√≠ticos o gastos fuertes.</li>';
            }
        }
        
        // --- VISTAS SECUNDARIAS ---
        
        function switchAnalysisTab(button) {
            // Desactiva solo los botones de veh√≠culo si est√°s en Combustible, sino desactiva todos
            const selector = button.getAttribute('data-tab') ? '[data-tab]' : '[data-vehicle]';
            document.querySelectorAll(`.analysis-tabs ${selector}`).forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            if (button.getAttribute('data-tab')) {
                document.querySelectorAll('.analysis-content').forEach(content => content.style.display = 'none');
                const targetId = button.getAttribute('data-tab');
                document.getElementById('tab-' + targetId).style.display = 'block';

                if (targetId === 'combustible') {
                    // Carga los detalles del veh√≠culo activo por defecto
                    const activeVehicleBtn = document.querySelector('#vehicle-tabs .tab-btn.active') || document.querySelector('#vehicle-tabs .tab-btn');
                    if (activeVehicleBtn) loadFuelDetails(activeVehicleBtn);
                }
            }
        }
        
        // (3.2) Carga de detalles de Combustible por veh√≠culo
        async function loadFuelDetails(button) {
            // (3.1) Selector de veh√≠culo
            const vehicle = button.getAttribute('data-vehicle');
            document.querySelectorAll('#vehicle-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            document.getElementById('fuel-vehicle-title').textContent = vehicle.split(" ")[0];

            const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');
            
            // MOCK: checkCombustibleSemana(vehiculo)
            const resCombustible = await api("checkCombustibleSemana", { vehiculo: vehicle });
            const count = (resCombustible && resCombustible.cantidad) || Math.floor(Math.random() * 4) + 1; 
            
            // MOCK Totales hist√≥ricos
            document.getElementById('fuel-monthly').textContent = formatCurrency(2500000 + (Math.random() * 500000));
            document.getElementById('fuel-avg-cost').textContent = formatCurrency(35000 + (Math.random() * 5000));
            
            // (3.4) Estado por semana logic y alerta
            document.getElementById('fuel-weekly-count').textContent = `${count} cargas`;
            const alertBox = document.getElementById('fuel-alert-box');
            alertBox.className = 'kpi-item';
            
            if (count >= 3) {
                 alertBox.style.background = 'rgba(239, 68, 68, 0.3)';
                 alertBox.style.color = 'var(--danger)';
                 alertBox.innerHTML = `<div class="kpi-label">Cargas Semanales</div><div class="kpi-value">${count} cargas</div><small style="color:var(--danger);">¬°ALERTA! Exceso.</small>`;
            } else if (count === 2) {
                 alertBox.style.background = 'rgba(245, 158, 11, 0.3)';
                 alertBox.style.color = 'var(--warning)';
                 alertBox.innerHTML = `<div class="kpi-label">Cargas Semanales</div><div class="kpi-value">${count} cargas</div><small style="color:var(--warning);">Nivel normal.</small>`;
            } else {
                 alertBox.style.background = 'rgba(16, 185, 129, 0.15)';
                 alertBox.style.color = 'var(--success)';
                 alertBox.innerHTML = `<div class="kpi-label">Cargas Semanales</div><div class="kpi-value">${count} cargas</div><small style="color:var(--success);">Bajo consumo.</small>`;
            }
            
            // (3.2) Lista de cargas reales (MOCK data structure)
            const listEl = document.getElementById('fuel-load-list');
            let listHtml = '';
            for (let i = 0; i < count; i++) {
                const amount = 30000 + Math.floor(Math.random() * 10000);
                const hour = (10 + i) % 24 + ":" + Math.floor(Math.random() * 60).toString().padStart(2, '0');
                const user = i % 2 === 0 ? 'Laura' : 'Nico';
                listHtml += `
                    <li style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <span>${new Date().toLocaleDateString('es-AR')} - ${hour} (${user})</span>
                        <span style="font-weight:700;">${formatCurrency(amount)}</span>
                    </li>
                `;
            }
            listEl.innerHTML = listHtml || '<li style="color:var(--text-muted);">No hay cargas registradas esta semana.</li>';
        }
        window.loadFuelDetails = loadFuelDetails; // Expose for HTML onclick

        // (4.3) Marcar notificaci√≥n como le√≠da
        async function marcarComoLeida(id, element) {
            // MOCK: This would call backend's marcarNotificacionLeida(id)
            // const res = await api("marcarNotificacionLeida", { id });
            
            // if (res && res.ok) {
                element.closest('.alert-item').style.opacity = 0.5;
                element.closest('.alert-item').style.pointerEvents = 'none';
                element.textContent = '‚úÖ Le√≠da';
                element.style.background = 'none';
                element.style.color = 'var(--success)';
                
                setTimeout(() => {
                    element.closest('.alert-item').remove();
                    loadAlertsBadge(); // Update the badge
                    loadSecurityPanel(); // Re-render the panel
                }, 500);
            // }
        }

        async function loadSecurityPanel() {
            // (4.1) MOCK data para testear la separaci√≥n por severidad y contexto
            const res = [
                { id: '1', fecha: new Date().toISOString(), severidad: 'ALTA', titulo: 'Fraude por Diferencia', mensaje: 'Diferencia de $32.000 detectada tras Arqueo.', contexto: { metricas: { diff: 32000 }, movimiento: 'Arqueo 28/11' } },
                { id: '2', fecha: new Date().toISOString(), severidad: 'ALTA', titulo: 'Movimiento Sospechoso', mensaje: 'Movimiento libre registrado 4 mins despu√©s del Arqueo.', contexto: { movimiento: 'Egreso Libre', tiempo: '4 mins' } },
                { id: '3', fecha: new Date().toISOString(), severidad: 'MEDIA', titulo: 'Patr√≥n de Edici√≥n', mensaje: 'Laura edit√≥ el conteo de billetes 12 veces antes de Rendir.', contexto: { metricas: { edits: 12 } } },
                { id: '4', fecha: new Date().toISOString(), severidad: 'MEDIA', titulo: 'M√∫ltiples Arqueos', mensaje: 'Se han registrado 3 Arqueos con diferencias hoy.', contexto: { metricas: { count: 3 } } },
                { id: '5', fecha: new Date().toISOString(), severidad: 'BAJA', titulo: 'Carga Fuera de Horario', mensaje: 'Carga de combustible en Saveiro a las 02:30 AM.', contexto: { movimiento: 'Combustible', hora: '02:30' } },
                { id: '6', fecha: new Date().toISOString(), severidad: 'BAJA', titulo: 'Sistema Estable', mensaje: 'Nada cr√≠tico reportado en las √∫ltimas 48hs.', contexto: {} },
            ]; 
            
            const criticalList = document.getElementById('critical-alerts');
            const mediumList = document.getElementById('medium-alerts');
            const infoList = document.getElementById('info-alerts');
            
            criticalList.innerHTML = '';
            mediumList.innerHTML = '';
            infoList.innerHTML = '';
            
            if (!res || res.length === 0) {
                 infoList.innerHTML = '<li class="alert-item info"><span class="material-icons-round">thumb_up</span> Sistema estable. Nada sospechoso en las √∫ltimas 48hs.</li>';
                 document.getElementById('alert-badge').textContent = '0';
                 document.getElementById('alert-badge').style.display = 'none';
                 return;
            }

            let criticalCount = 0;
            const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');

            res.forEach(alert => {
                // (4.2) Extract context details for better narrative display
                let details = alert.mensaje;
                
                if (alert.contexto && alert.contexto.metricas) {
                    if (alert.contexto.metricas.diff) {
                        details = `Diferencia de ${formatCurrency(alert.contexto.metricas.diff)} en Arqueo.`;
                    }
                    if (alert.contexto.metricas.edits) {
                        details = `Patr√≥n de edici√≥n: ${alert.contexto.metricas.edits} cambios antes de Rendir.`;
                    }
                }
                
                const time = new Date(alert.fecha).toLocaleDateString('es-AR', { hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('li');
                
                // (4.3) Add "Mark as read" button for actionable alerts
                const actionButton = (alert.severidad === 'ALTA' || alert.severidad === 'MEDIA') ? 
                    `<button style="background:var(--card-bg); color:var(--text-light); border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:5px 10px; cursor:pointer; flex-shrink: 0;" onclick="marcarComoLeida('${alert.id}', this)">Marcar Le√≠da</button>` : '';

                li.innerHTML = `
                    <span class="material-icons-round">${alert.severidad === 'ALTA' ? 'warning' : alert.severidad === 'MEDIA' ? 'info' : 'notifications'}</span> 
                    <div style="flex-grow:1;">
                        <span style="font-weight:700;">${alert.titulo}</span>
                        <div style="color:var(--text-muted); font-size:0.85rem;">${details} (${time})</div>
                    </div>
                    ${actionButton}
                `;
                
                if (alert.severidad === 'ALTA') {
                    li.classList.add('alert-item', 'critical');
                    criticalCount++;
                    criticalList.appendChild(li);
                } else if (alert.severidad === 'MEDIA') {
                    li.classList.add('alert-item', 'medium');
                    mediumList.appendChild(li);
                } else {
                    li.classList.add('alert-item', 'info');
                    infoList.appendChild(li);
                }
            });
            
            document.getElementById('alert-badge').textContent = criticalCount;
            document.getElementById('alert-badge').style.display = criticalCount > 0 ? 'block' : 'none';
        }
        
        window.loadSecurityPanel = loadSecurityPanel; // Expose to global scope
        window.marcarComoLeida = marcarComoLeida; // Expose to global scope

        // (5) Buscador Global REAL (con narrativa mock)
        async function performSearch() {
            const query = document.getElementById('global-search').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            if (!query) {
                resultsDiv.innerHTML = '<p style="color:var(--text-muted);">Por favor, introduce un t√©rmino de b√∫squeda.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p style="color:var(--primary-accent);">üîç Buscando en todos los registros (movimientos, alertas, arqueos)...</p>';
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            // Simulaci√≥n de b√∫squeda real con narrativa compleja (Mock)
            let mockResult = '';
            let totalFound = 0;
            const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');

            if (query.includes('combustible toyota')) {
                 totalFound += 3;
                 mockResult += `
                    <p style="font-weight:700; color:var(--success);">‚úÖ Encontr√© 3 cargas de combustible en Toyota Hiace en los √∫ltimos 7 d√≠as. </p>
                    <div class="history-item">Total gastado: ${formatCurrency(125000)}. Una de ellas fue registrada a las 02:30 AM, fuera de horario habitual, generando una alerta de RIESGO BAJO.</div>
                 `;
            } 
            if (query.includes('adelanto laura')) {
                 totalFound += 1;
                 mockResult += `
                    <p style="font-weight:700; color:var(--primary-accent);">üë§ 1 adelanto para Laura encontrado en el mes. </p>
                    <div class="history-item">Movimiento: Egreso - Adelanto de Sueldo | Importe: ${formatCurrency(40000)} | Fecha: 01/11.</div>
                 `;
            } 
            if (query.includes('ajuste raro') || query.includes('fraude')) {
                 totalFound += 2;
                 mockResult += `
                    <p style="font-weight:700; color:var(--danger);">üö® Alerta de Seguridad: Encontr√© 2 anomal√≠as de ajuste/fraude.</p>
                    <div class="history-item">Patr√≥n sospechoso: 2 Arqueos con diferencias exactas seguidas de Movimientos Libres en la √∫ltima semana. Total en juego: ${formatCurrency(55000)}.</div>
                 `;
            }
            if (totalFound === 0) {
                 mockResult = `<p style="font-weight:700; color:var(--text-muted);">‚ùå Busqu√© en 4.120 movimientos y no encontr√© coincidencias relevantes para "${query}".</p>`;
            } else {
                 mockResult = `<p style="font-weight:700; color:var(--text-light);">Busqu√© en miles de movimientos y encontr√© ${totalFound} resultados relevantes:</p>` + mockResult;
            }
            
            resultsDiv.innerHTML = mockResult;
        }

        async function loadDayDetail(dateStr) {
            const date = new Date(dateStr);
            const detailTitle = document.getElementById('day-detail-title');
            const detailContent = document.getElementById('day-detail-content');
            
            detailTitle.textContent = `Detalle del D√≠a: ${date.toLocaleDateString('es-AR')}`;
            detailContent.innerHTML = '<p style="color:var(--text-muted);">Cargando movimientos y eventos de ese d√≠a...</p>';
            
            const movements = await api("getMovimientos", { fechaStr: dateStr }); // (2.1)
            
            if (!movements || movements.error || movements.length === 0) {
                 detailContent.innerHTML = '<p style="color:var(--text-muted); padding:20px;">No se encontraron movimientos para esta fecha.</p>';
                 return;
            }
            
            let html = '<h4>Movimientos (Hora)</h4><ul style="list-style:none; padding:0;">';
            movements.forEach(m => {
                 const sign = m.tipo === 'Ingreso' ? '+' : '-';
                 const color = m.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)';
                 html += `
                    <li style="margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:5px;">
                        <span style="font-weight:700;">${m.hora}</span> - ${m.categoria} <br>
                        <span style="color:${color}; font-weight:700; font-size:1.1rem;">${sign} ${m.importe.toLocaleString('es-AR')}</span> | Obs: ${m.observacion || 'N/D'}
                    </li>
                 `;
            });
            html += '</ul>';
            detailContent.innerHTML = html;
        }


    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Mercado Limpio - Due√±o</title>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILOS V1.0: DASHBOARD DUE√ëO (DARK EXECUTIVE)
           ========================================= */
        :root {
            --bg-dark: #1F2937; /* Gris oscuro / Azul oscuro */
            --card-bg: #374151; /* Gris m√°s claro para tarjetas */
            --text-light: #F9FAFB;
            --text-muted: #D1D5DB;
            --primary-accent: #3B82F6; /* Azul brillante */
            --success: #10B981; /* Verde */
            --warning: #F59E0B; /* Amarillo */
            --danger: #EF4444; /* Rojo */
            --alert-critical: #991B1B;
            --alert-medium: #FCD34D;
            --alert-low: #6EE7B7;
            --kpi-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            padding-bottom: 90px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .app-header { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(31, 41, 55, 0.95); /* Semi-transparente oscuro */
            backdrop-filter: blur(8px); 
            position: sticky; 
            top: 0; 
            z-index: 50; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
        }
        .app-title { font-size: 1.3rem; font-weight: 900; color: var(--primary-accent); display: flex; align-items: center; gap: 8px; }
        .header-actions { display: flex; align-items: center; gap: 15px; }

        .date-display { font-size: 0.9rem; font-weight: 400; color: var(--text-muted); }
        .notification-icon { position: relative; cursor: pointer; color: var(--text-light); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 700; line-height: 1; }

        /* --- CARDS & LAYOUT --- */
        .content-container { padding: 15px; }
        .card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: var(--kpi-shadow); 
        }
        .section-title { 
            font-size: 1.1rem; 
            color: var(--text-light); 
            font-weight: 700; 
            margin-bottom: 15px; 
            border-bottom: 2px solid rgba(255,255,255,0.05);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- KPI GRIDS --- */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .kpi-item {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .kpi-label { font-size: 0.8rem; font-weight: 400; color: var(--text-muted); margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 900; line-height: 1.2; }
        
        .kpi-ingreso { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .kpi-egreso { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .kpi-neto-pos { background: rgba(59, 130, 246, 0.15); color: var(--primary-accent); }
        .kpi-neto-neg { background: rgba(239, 68, 68, 0.3); color: var(--danger); }
        
        /* --- NARRATIVA INTELIGENTE --- */
        .narrativa-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-accent);
            line-height: 1.5;
            font-size: 0.95rem;
        }
        .narrativa-title { font-weight: 700; color: var(--primary-accent); margin-bottom: 5px; }
        .highlight-green { color: var(--success); font-weight: 700; }
        .highlight-red { color: var(--danger); font-weight: 700; }

        /* --- METRICA RIESGO (FLAG) --- */
        .risk-flag-container { 
            padding: 20px; 
            border-radius: 16px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .risk-flag-container h3 { margin: 0 0 5px; font-size: 1.1rem; }
        .risk-flag-container .ratio { font-size: 2.5rem; font-weight: 900; margin-bottom: 5px; }
        
        .risk-green { background: rgba(16, 185, 129, 0.2); border: 2px solid var(--success); color: var(--success); }
        .risk-yellow { background: rgba(245, 158, 11, 0.2); border: 2px solid var(--warning); color: var(--warning); }
        .risk-red { background: rgba(239, 68, 68, 0.2); border: 2px solid var(--danger); color: var(--danger); }

        /* --- GRAFICOS (MOCK) --- */
        .chart-mock {
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        /* --- ANALISIS R√ÅPIDO (TABS) --- */
        .analysis-tabs { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 10px; margin-bottom: 15px; }
        .tab-btn {
            background: var(--card-bg);
            color: var(--text-muted);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn.active {
            background: var(--primary-accent);
            color: var(--text-light);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .analysis-content { animation: fadeIn 0.4s; }

        /* --- SEGURIDAD / ALERTS --- */
        .alert-list { list-style: none; padding: 0; }
        .alert-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
        }
        .alert-item.critical { background: var(--alert-critical); border-left: 5px solid var(--danger); }
        .alert-item.medium { background: rgba(245, 158, 11, 0.2); border-left: 5px solid var(--warning); color: var(--warning); }
        .alert-item.info { background: rgba(59, 130, 246, 0.1); border-left: 5px solid var(--primary-accent); color: var(--text-muted); }

        /* --- BUSCADOR --- */
        #global-search { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 2px solid var(--card-bg); 
            background: var(--bg-dark); 
            color: var(--text-light); 
            font-size: 1rem; 
            margin-bottom: 15px;
        }

        /* --- NAV --- */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(31, 41, 55, 0.95); 
            backdrop-filter: blur(8px); 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3); 
            z-index: 100; 
        }
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: var(--text-muted); 
            text-decoration: none; 
            font-size: 0.75rem; 
            font-weight: 700; 
            transition: color 0.2s, background 0.2s; 
            padding: 8px 10px;
            border-radius: 8px;
        }
        .nav-item.active { 
            color: var(--primary-accent); 
            background: rgba(59, 130, 246, 0.1); 
        }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        /* --- UTILS --- */
        .screen { display: none; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- AUXILIAR SIMULACION (PARA LA HISTORIA) --- */
        .history-item { 
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-accent);
        }
        .history-item-title { font-weight: 700; margin-bottom: 5px; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="app-header">
        <div class="app-title"><span class="material-icons-round">analytics</span> Dashboard Due√±o</div>
        <div class="header-actions">
            <div class="date-display" id="current-date">Cargando...</div>
            <div class="notification-icon" onclick="showScreen('seguridad', document.querySelector('.nav-item[data-screen=\'seguridad\']'))">
                <span class="material-icons-round">notifications</span>
                <span class="badge" id="alert-badge">0</span>
            </div>
            <span class="material-icons-round" style="cursor:pointer;" onclick="fetchDashboardData()">refresh</span>
        </div>
    </header>

    <div class="content-container">

        <!-- 1. DASHBOARD DIARIO INTELIGENTE (INICIO) -->
        <div id="screen-inicio" class="screen active">
            
            <div class="risk-flag-container" id="risk-flag">
                <h3 id="risk-title">Calculando M√©trica...</h3>
                <div class="ratio" id="risk-ratio">--%</div>
                <p id="risk-message" style="font-size:0.9rem; margin: 0;"></p>
            </div>

            <div class="card">
                <div class="section-title"><span class="material-icons-round">insights</span> Pulso de Hoy</div>
                <div class="kpi-grid">
                    <div class="kpi-item kpi-ingreso">
                        <div class="kpi-label">Ingreso Total</div>
                        <div class="kpi-value" id="kpi-ingreso">--</div>
                    </div>
                    <div class="kpi-item kpi-egreso">
                        <div class="kpi-label">Egreso Total</div>
                        <div class="kpi-value" id="kpi-egreso">--</div>
                    </div>
                    <div class="kpi-item kpi-neto-pos" id="kpi-neto-box">
                        <div class="kpi-label">Resultado Neto</div>
                        <div class="kpi-value" id="kpi-neto">--</div>
                    </div>
                    <div class="kpi-item" style="background:rgba(255,255,255,0.05);">
                        <div class="kpi-label">Proyecci√≥n Mensual</div>
                        <div class="kpi-value" style="color:var(--text-light); font-size:1.5rem;" id="kpi-proyeccion">--</div>
                    </div>
                </div>

                <!-- NARRATIVA INTELIGENTE -->
                <div class="narrativa-box">
                    <div class="narrativa-title">An√°lisis R√°pido</div>
                    <div id="narrativa-diaria">Cargando...</div>
                </div>
            </div>

            <div class="card">
                <div class="section-title"><span class="material-icons-round">pie_chart</span> Ranking de Gastos (Hoy)</div>
                <div class="chart-mock" id="gasto-ranking">
                    
                </div>
                <ul id="ranking-list" style="list-style:none; padding:0; font-size:0.9rem;">
                    <!-- Se rellena con JS -->
                </ul>
            </div>
            
            <div class="card">
                <div class="section-title"><span class="material-icons-round">bolt</span> D√≠a Cr√≠tico (Resumen)</div>
                <div id="dia-critico-resumen">
                    <!-- M√≥dulo D√≠a Cr√≠tico -->
                    <p style="color:var(--text-muted);">Cargando √≠tems clave:</p>
                    <ul id="critical-items" style="list-style:none; padding:0;">
                        <!-- Se rellena con JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. DIAS ANTERIORES + VISTA DETALLADA -->
        <div id="screen-dias" class="screen">
            <div class="card">
                <div class="section-title"><span class="material-icons-round">calendar_today</span> Selecci√≥n de Fecha</div>
                <input type="date" id="date-selector" class="form-control" onchange="loadDayDetail(this.value)" style="width:100%; margin-bottom:15px; padding:10px;">
                <div class="section-title" id="day-detail-title">Detalle del D√≠a Seleccionado</div>
                <div class="chart-mock" style="height:200px; margin-bottom:15px;">
                    
                </div>
                <div id="day-detail-content">
                    <p style="color:var(--text-muted);">Selecciona una fecha para ver el detalle de movimientos, rendiciones y ajustes.</p>
                </div>
            </div>
        </div>

        <!-- 3. AN√ÅLISIS (Combustible, Sueldos, Proveedores) -->
        <div id="screen-analisis" class="screen">
            <div class="section-title"><span class="material-icons-round">data_usage</span> An√°lisis por Rubro</div>

            <div class="analysis-tabs">
                <button class="tab-btn active" data-tab="combustible" onclick="switchAnalysisTab(this)">üî• Combustible</button>
                <button class="tab-btn" data-tab="empleados" onclick="switchAnalysisTab(this)">üë• Empleados</button>
                <button class="tab-btn" data-tab="proveedores" onclick="switchAnalysisTab(this)">üöö Proveedores</button>
            </div>

            <div class="analysis-content active" id="tab-combustible">
                <div class="card">
                    <div class="section-title"><span class="material-icons-round">local_gas_station</span> Informe Combustible</div>
                    <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="kpi-item" style="background:rgba(255,255,255,0.05);">
                            <div class="kpi-label">Total Mensual</div>
                            <div class="kpi-value" id="fuel-monthly">--</div>
                        </div>
                        <div class="kpi-item" style="background:rgba(255,255,255,0.05);">
                            <div class="kpi-label">Costo Promedio</div>
                            <div class="kpi-value" id="fuel-avg-cost">--</div>
                        </div>
                        <div class="kpi-item" id="fuel-alert-box">
                            <div class="kpi-label">Cargas Semanales</div>
                            <div class="kpi-value" id="fuel-weekly-count">--</div>
                        </div>
                    </div>
                    <div class="chart-mock" style="margin-top:15px;">
                        
                    </div>
                </div>
            </div>

            <div class="analysis-content" id="tab-empleados" style="display:none;">
                <div class="card">
                    <div class="section-title"><span class="material-icons-round">payments</span> Sueldos y Adelantos</div>
                    <p>Adelantos realizados este mes:</p>
                    <ul id="adelantos-list" style="list-style:disc; padding-left:20px; font-size:0.9rem; color:var(--text-muted);">
                        <li>Laura: $40.000</li>
                        <li>Nico: $10.000</li>
                    </ul>
                    <div class="chart-mock" style="height:120px; margin-top:15px;">
                        
                    </div>
                </div>
            </div>

            <div class="analysis-content" id="tab-proveedores" style="display:none;">
                <div class="card">
                    <div class="section-title"><span class="material-icons-round">inventory_2</span> Ranking de Proveedores</div>
                    <p>Top 3 gastos (√öltimas 4 semanas):</p>
                    <ol id="proveedor-ranking" style="padding-left:20px; font-size:0.9rem;">
                        <li>Romyl: $1.2M <span class="highlight-red">(-5% vs Sem. Ant.)</span></li>
                        <li>Distribuidora: $850K <span class="highlight-green">(+12% vs Sem. Ant.)</span></li>
                        <li>Proveedor X: $320K</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- 4. SEGURIDAD / ANTI-FRAUDE -->
        <div id="screen-seguridad" class="screen">
            <div class="section-title"><span class="material-icons-round">security</span> Panel Anti-Fraude (La Joya)</div>
            <div class="card">
                <h3 style="color:var(--danger); margin-top:0;">üî¥ ALERTAS CR√çTICAS</h3>
                <ul class="alert-list" id="critical-alerts">
                    <li class="alert-item critical">
                        <span class="material-icons-round">warning</span> 
                        Diferencia elevada de $32.000 en el √∫ltimo Arqueo.
                    </li>
                    <li class="alert-item critical">
                        <span class="material-icons-round">visibility_off</span> 
                        Movimiento libre registrado 4 mins despu√©s del Arqueo.
                    </li>
                </ul>

                <h3 style="color:var(--warning);">üü° RIESGO MODERADO</h3>
                <ul class="alert-list" id="medium-alerts">
                    <li class="alert-item medium">
                        <span class="material-icons-round">info</span> 
                        Se han registrado 3 Arqueos con diferencias hoy.
                    </li>
                    <li class="alert-item medium">
                        <span class="material-icons-round">edit</span> 
                        Laura edit√≥ el conteo de billetes 12 veces antes de Rendir.
                    </li>
                </ul>

                <h3 style="color:var(--primary-accent);">üü¢ INFORMACI√ìN</h3>
                <ul class="alert-list" id="info-alerts">
                    <li class="alert-item info">
                        <span class="material-icons-round">lock</span> 
                        Sistema estable. Nada sospechoso en las √∫ltimas 48hs.
                    </li>
                </ul>
            </div>
        </div>

        <!-- 5. BUSCADOR GLOBAL -->
        <div id="screen-buscador" class="screen">
            <div class="section-title"><span class="material-icons-round">travel_explore</span> Buscador Global con IA</div>
            <input type="text" id="global-search" placeholder="Ej: combustible toyota, adelanto laura, ajuste raro...">
            <button class="tab-btn active" onclick="performSearch()" style="width:100%;">BUSCAR</button>
            <div class="card" style="margin-top:15px;">
                <div class="section-title">Resultados con Narrativa</div>
                <div id="search-results">
                    <p style="color:var(--text-muted);">Escribe tu consulta arriba para buscar en todos los movimientos, rendiciones y alertas.</p>
                </div>
            </div>
        </div>

        <!-- 6. AUDITOR√çAS SEMANALES -->
        <div id="screen-auditorias" class="screen">
            <div class="section-title"><span class="material-icons-round">checklist</span> Historial de Auditor√≠as Semanales</div>
            <div class="card">
                <h3 style="color:var(--text-light); margin-top:0;">Auditor√≠a de la semana (Lunes 25/11 - Hoy)</h3>
                <ul id="auditoria-current" style="list-style:none; padding:0; font-size:0.9rem;">
                    <li style="margin-bottom:5px;">Ingresos: <span class="highlight-green">$ 4.5M</span></li>
                    <li style="margin-bottom:5px;">Egresos: <span class="highlight-red">$ 2.2M</span></li>
                    <li style="margin-bottom:5px;">Riesgo (Gastos/Ingresos): <span class="highlight-green">48.9%</span></li>
                    <li style="margin-bottom:5px; font-weight:700;">Movimiento Libre: <span class="highlight-red">$ 120.000</span> (Revisar)</li>
                </ul>
                
                <div style="margin-top:20px;">
                    <h3 style="color:var(--text-muted);">Historial de las 10 √∫ltimas</h3>
                    <div id="auditoria-historial">
                        <div class="history-item">
                            <div class="history-item-title">Semana 18 Nov - 22 Nov</div>
                            <span class="highlight-green">Riesgo: 42% (OK)</span>
                        </div>
                        <div class="history-item">
                            <div class="history-item-title">Semana 11 Nov - 15 Nov</div>
                            <span class="highlight-yellow">Riesgo: 65% (Precauci√≥n)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- NAV -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-screen="inicio" onclick="showScreen('inicio', this)">
            <span class="material-icons-round nav-icon">dashboard</span> <span>Inicio</span>
        </a>
        <a href="#" class="nav-item" data-screen="dias" onclick="showScreen('dias', this)">
            <span class="material-icons-round nav-icon">event_note</span> <span>D√≠as</span>
        </a>
        <a href="#" class="nav-item" data-screen="analisis" onclick="showScreen('analisis', this)">
            <span class="material-icons-round nav-icon">bar_chart</span> <span>An√°lisis</span>
        </a>
        <a href="#" class="nav-item" data-screen="seguridad" onclick="showScreen('seguridad', this)">
            <span class="material-icons-round nav-icon">lock</span> <span>Seguridad</span>
        </a>
        <a href="#" class="nav-item" data-screen="buscador" onclick="showScreen('buscador', this)">
            <span class="material-icons-round nav-icon">search</span> <span>Buscar</span>
        </a>
        <a href="#" class="nav-item" data-screen="auditorias" onclick="showScreen('auditorias', this)">
            <span class="material-icons-round nav-icon">history_toggle_off</span> <span>Auditor√≠as</span>
        </a>
    </nav>

    <script>
        // La URL de tu API del backend de Apps Script (es la misma)
        const API_URL = "https://cajamercadolimpio.santamariapablodaniel.workers.dev/";
        const USUARIO_APP = "Pablo (Due√±o)";

        document.addEventListener("DOMContentLoaded", () => {
            initApp();
        });

        function initApp() {
            setInitialDate();
            fetchDashboardData();
            loadAlertsBadge();
        }
        
        // --- UTILS ---
        function setInitialDate() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const todayFmt = `${dd}/${mm}/${yyyy}`;
            document.getElementById('current-date').textContent = todayFmt;
            document.getElementById('date-selector').value = `${yyyy}-${mm}-${dd}`;
        }
        
        window.showScreen = (id, el) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            // Recargar datos espec√≠ficos si se cambia a An√°lisis/Seguridad
            if (id === 'analisis') {
                switchAnalysisTab(document.querySelector('.tab-btn.active') || document.querySelector('.tab-btn'));
            }
            if (id === 'seguridad') {
                loadSecurityPanel();
            }
        };

        // --- API & DATA FETCHING ---
        async function api(fn, params = {}) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ fn, params })
                });
                return await res.json();
            } catch (e) {
                console.error("Error en la llamada a la API:", e);
                return null;
            }
        }
        
        async function loadAlertsBadge() {
            const res = await api("getNotificacionesCaja", { soloActivas: true });
            const count = (res && res.length) || 0;
            document.getElementById('alert-badge').textContent = count;
            document.getElementById('alert-badge').style.display = count > 0 ? 'block' : 'none';
        }

        async function fetchDashboardData() {
            // MOCK: En una app real, esta funci√≥n de backend (getDailyMetrics) devolver√≠a todo precalculado.
            // Aqu√≠, simulamos el c√°lculo del backend usando los movimientos del d√≠a.
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const movements = await api("getMovimientos", { fechaStr: todayStr + "T12:00:00" });

            if (!movements || movements.error) {
                console.error("No se pudieron cargar los movimientos diarios.");
                return;
            }

            // --- 1. C√ÅLCULO DE KPIs ---
            let ingresos = 0;
            let egresos = 0;
            let totalEgreso = 0;
            const gastosPorCategoria = {};
            const MOVIMIENTOS_CRITICOS = [];
            
            movements.forEach(m => {
                const importe = m.importe;
                if (m.tipo === 'Ingreso') {
                    ingresos += importe;
                } else {
                    egresos += importe;
                    totalEgreso += importe;
                    
                    const cat = m.categoria.split(" ")[0]; // Simplificar categor√≠a para el ranking
                    gastosPorCategoria[cat] = (gastosPorCategoria[cat] || 0) + importe;
                }
                
                // M√ìDULO D√çA CR√çTICO - Identificaci√≥n de eventos clave
                if (m.categoria.includes('Rendici√≥n') || m.categoria.includes('Ajuste') || m.categoria.includes('Combustible') || importe > 50000) {
                    MOVIMIENTOS_CRITICOS.push({
                        type: m.categoria,
                        amount: m.importe,
                        time: m.hora,
                        obs: m.observacion
                    });
                }
            });

            const neto = ingresos - egresos;
            const riesgo = ingresos > 0 ? (egresos / ingresos) * 100 : 100;

            // --- 2. DISPLAY DE KPIS ---
            const formatCurrency = (num) => "$ " + parseInt(num).toLocaleString('es-AR');
            
            document.getElementById('kpi-ingreso').textContent = formatCurrency(ingresos);
            document.getElementById('kpi-egreso').textContent = formatCurrency(egresos);
            document.getElementById('kpi-neto').textContent = formatCurrency(neto);
            
            const netoBox = document.getElementById('kpi-neto-box');
            netoBox.className = 'kpi-item ' + (neto >= 0 ? 'kpi-neto-pos' : 'kpi-neto-neg');
            
            // --- 3. METRICA DE RIESGO ---
            const flagContainer = document.getElementById('risk-flag');
            flagContainer.className = 'risk-flag-container';
            let flagMsg, flagTitle;

            if (riesgo <= 55) {
                flagContainer.classList.add('risk-green');
                flagTitle = 'üü¢ BANDERA VERDE';
                flagMsg = 'Gastos bajo control. La rentabilidad de hoy es excelente.';
            } else if (riesgo <= 75) {
                flagContainer.classList.add('risk-yellow');
                flagTitle = 'üü° BANDERA AMARILLA';
                flagMsg = 'Precauci√≥n: Gastos en ascenso. Monitorea los egresos de la tarde.';
            } else {
                flagContainer.classList.add('risk-red');
                flagTitle = 'üî¥ BANDERA ROJA';
                flagMsg = '¬°Alerta! Los egresos superan o igualan el 75% de tus ingresos.';
            }

            document.getElementById('risk-title').textContent = flagTitle;
            document.getElementById('risk-ratio').textContent = `${riesgo.toFixed(1)}%`;
            document.getElementById('risk-message').textContent = flagMsg;
            
            // --- 4. PROYECCI√ìN MENSUAL ---
            const daysInMonth = 30; // Simplificaci√≥n
            const projNeto = (neto * daysInMonth);
            document.getElementById('kpi-proyeccion').textContent = formatCurrency(projNeto);
            document.getElementById('kpi-proyeccion').style.color = projNeto >= 0 ? 'var(--success)' : 'var(--danger)';

            // --- 5. NARRATIVA INTELIGENTE (Simulaci√≥n) ---
            const sortedGastos = Object.entries(gastosPorCategoria)
                .sort(([, a], [, b]) => b - a);
            
            let narrativa = '';
            if (egresos === 0) {
                narrativa += '¬°Excelente! Hoy no hay egresos, solo ingresos. ';
            } else {
                const topGasto = sortedGastos[0];
                const topGastoPercent = (topGasto[1] / totalEgreso) * 100;
                
                narrativa += `Hoy est√°s gastando un <span class="${neto >= 0 ? 'highlight-green' : 'highlight-red'}">${riesgo.toFixed(1)}%</span> de lo que entra. `;
                narrativa += `<br><br>El rubro de **${topGasto[0]}** representa el <span class="highlight-red">${topGastoPercent.toFixed(1)}%</span> del egreso del d√≠a.`;
            }
            // Simular un chequeo de fraude basado en el backend
            const fraudAlert = (await api("getNotificacionesCaja", { soloActivas: true })).find(a => a.severidad === 'ALTA');
            if (fraudAlert) {
                narrativa += `<br><br>üö® **ALERTA DE SEGURIDAD**: Se detect√≥ un patr√≥n de ${fraudAlert.titulo} (${fraudAlert.mensaje}). Revisa el panel de Seguridad.`;
            }
            
            document.getElementById('narrativa-diaria').innerHTML = narrativa;
            
            // --- 6. RANKING DE GASTOS ---
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            sortedGastos.slice(0, 4).forEach(([cat, amount]) => {
                const percent = (amount / totalEgreso) * 100;
                rankingList.innerHTML += `
                    <li style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>${cat}</span>
                        <span>${percent.toFixed(1)}% (${formatCurrency(amount)})</span>
                    </li>
                `;
            });

            // --- 7. D√çA CR√çTICO ---
            const criticalList = document.getElementById('critical-items');
            criticalList.innerHTML = '';
            MOVIMIENTOS_CRITICOS.forEach(item => {
                 criticalList.innerHTML += `
                    <li style="margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:5px;">
                        <span class="material-icons-round" style="font-size:1rem; vertical-align:middle; color:var(--warning);">check_circle</span>
                        <b>${item.type}:</b> ${formatCurrency(item.amount)} a las ${item.time}.
                    </li>
                `;
            });
            if (MOVIMIENTOS_CRITICOS.length === 0) {
                 criticalList.innerHTML = '<li style="color:var(--success);">D√≠a sin eventos cr√≠ticos o gastos fuertes.</li>';
            }
        }
        
        // --- VISTAS SECUNDARIAS ---
        
        function switchAnalysisTab(button) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            document.querySelectorAll('.analysis-content').forEach(content => content.style.display = 'none');
            const targetId = button.getAttribute('data-tab');
            document.getElementById('tab-' + targetId).style.display = 'block';

            // Cargar datos espec√≠ficos de Combustible
            if (targetId === 'combustible') {
                loadCombustibleAnalysis();
            }
        }
        
        async function loadCombustibleAnalysis() {
            // MOCK: En una app real, llamar√≠as a checkCombustibleSemana para cada veh√≠culo
            // y a funciones para obtener totales semanales/mensuales.
            
            document.getElementById('fuel-monthly').textContent = "$ 2.500.000";
            document.getElementById('fuel-avg-cost').textContent = "$ 35.000";
            
            // Simular checkCombustibleSemana(vehiculo) para Saveiro
            const resCombustible = await api("checkCombustibleSemana", { vehiculo: "Volkswagen Saveiro" });
            const count = (resCombustible && resCombustible.cantidad) || 3; // Simular 3 cargas
            
            document.getElementById('fuel-weekly-count').textContent = `${count} cargas`;
            const alertBox = document.getElementById('fuel-alert-box');
            alertBox.className = 'kpi-item';
            
            if (count >= 3) {
                 alertBox.style.background = 'rgba(239, 68, 68, 0.3)';
                 alertBox.style.color = 'var(--danger)';
            } else if (count === 2) {
                 alertBox.style.background = 'rgba(245, 158, 11, 0.3)';
                 alertBox.style.color = 'var(--warning)';
            } else {
                 alertBox.style.background = 'rgba(16, 185, 129, 0.15)';
                 alertBox.style.color = 'var(--success)';
            }
        }

        async function loadSecurityPanel() {
            const res = await api("getNotificacionesCaja", { soloActivas: true });
            
            const criticalList = document.getElementById('critical-alerts');
            const mediumList = document.getElementById('medium-alerts');
            const infoList = document.getElementById('info-alerts');
            
            criticalList.innerHTML = '';
            mediumList.innerHTML = '';
            infoList.innerHTML = '';
            
            // MOCK: Usar los datos reales del backend (Notificaciones)
            if (!res || res.length === 0) {
                 infoList.innerHTML = '<li class="alert-item info"><span class="material-icons-round">thumb_up</span> Sistema estable. Nada sospechoso en las √∫ltimas 48hs.</li>';
                 document.getElementById('alert-badge').textContent = '0';
                 document.getElementById('alert-badge').style.display = 'none';
                 return;
            }

            let criticalCount = 0;

            res.forEach(alert => {
                const time = new Date(alert.fecha).toLocaleDateString('es-AR', { hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('li');
                li.innerHTML = `<span class="material-icons-round">${alert.severidad === 'ALTA' ? 'warning' : alert.severidad === 'MEDIA' ? 'info' : 'notifications'}</span> <span>${alert.titulo}: ${alert.mensaje} (${time})</span>`;
                
                if (alert.severidad === 'ALTA') {
                    li.classList.add('alert-item', 'critical');
                    criticalCount++;
                    criticalList.appendChild(li);
                } else if (alert.severidad === 'MEDIA') {
                    li.classList.add('alert-item', 'medium');
                    mediumList.appendChild(li);
                } else {
                    li.classList.add('alert-item', 'info');
                    infoList.appendChild(li);
                }
            });
            
            document.getElementById('alert-badge').textContent = criticalCount;
            document.getElementById('alert-badge').style.display = criticalCount > 0 ? 'block' : 'none';
        }
        
        async function loadDayDetail(dateStr) {
            const date = new Date(dateStr);
            const detailTitle = document.getElementById('day-detail-title');
            const detailContent = document.getElementById('day-detail-content');
            
            detailTitle.textContent = `Detalle del D√≠a: ${date.toLocaleDateString('es-AR')}`;
            detailContent.innerHTML = '<p style="color:var(--text-muted);">Cargando movimientos y eventos de ese d√≠a...</p>';
            
            const movements = await api("getMovimientos", { fechaStr: dateStr + "T12:00:00" });
            
            if (!movements || movements.error || movements.length === 0) {
                 detailContent.innerHTML = '<p style="color:var(--text-muted); padding:20px;">No se encontraron movimientos para esta fecha.</p>';
                 return;
            }
            
            let html = '<h4>Movimientos (Hora)</h4><ul style="list-style:none; padding:0;">';
            movements.forEach(m => {
                 const sign = m.tipo === 'Ingreso' ? '+' : '-';
                 const color = m.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)';
                 html += `
                    <li style="margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:5px;">
                        <span style="font-weight:700;">${m.hora}</span> - ${m.categoria} <br>
                        <span style="color:${color}; font-weight:700; font-size:1.1rem;">${sign} ${m.importe.toLocaleString('es-AR')}</span> | Obs: ${m.observacion || 'N/D'}
                    </li>
                 `;
            });
            html += '</ul>';
            detailContent.innerHTML = html;
        }

        async function performSearch() {
            const query = document.getElementById('global-search').value;
            const resultsDiv = document.getElementById('search-results');
            if (!query) {
                resultsDiv.innerHTML = '<p style="color:var(--text-muted);">Por favor, introduce un t√©rmino de b√∫squeda.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p style="color:var(--primary-accent);">üîç Buscando en todos los registros...</p>';

            // MOCK DE B√öSQUEDA CON IA (usar√≠a Google Search o un endpoint de Apps Script con l√≥gica de filtrado)
            
            // Simulaci√≥n de 5 segundos de b√∫squeda
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            // Simulaci√≥n de resultados
            let mockResult = '';
            if (query.toLowerCase().includes('combustible toyota')) {
                 mockResult = `
                    <p style="font-weight:700; color:var(--success);">‚úÖ Encontr√© 3 cargas de combustible en Toyota Hiace en los √∫ltimos 7 d√≠as. </p>
                    <div class="history-item">Total gastado: $125.000. Una de ellas fue registrada a las 02:30 AM (fuera de horario habitual).</div>
                 `;
            } else if (query.toLowerCase().includes('ajuste raro')) {
                 mockResult = `
                    <p style="font-weight:700; color:var(--danger);">üö® ¬°Alerta! 2 movimientos de "Ajuste Arqueo" en d√≠as distintos se realizaron a menos de 5 minutos del cierre. </p>
                    <div class="history-item">El √∫ltimo ocurri√≥ el 27/11 a las 23:56. Revisa el Panel de Seguridad.</div>
                 `;
            } else {
                 mockResult = `<p style="font-weight:700; color:var(--text-muted);">No encontr√© resultados exactos para "${query}". Intenta con un rubro o fecha espec√≠fica.</p>`;
            }
            
            resultsDiv.innerHTML = mockResult;
        }

    </script>
</body>
</html>
